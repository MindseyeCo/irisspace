<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Iris Space</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0A0A0A">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/0891b2/ffffff?text=IS">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600&family=Playfair+Display:wght@700&display=swap');
        
        :root {
            --cyan-glow: 0 0 8px rgba(34, 211, 238, 0.6), 0 0 16px rgba(34, 211, 238, 0.4), 0 0 24px rgba(34, 211, 238, 0.2);
        }

        .dark {
            --bg-primary: #0A0A0A;
            --bg-secondary: #101010;
            --surface: #1A1A1A;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --accent: #22D3EE; /* Brighter Cyan */
            --accent-light: #A5F3FC;
            --border-color: #2A2A2A; /* Corrected border color */
            --font-body: 'Sora', sans-serif;
            --font-title: 'Playfair Display', serif;
        }
        
        body {
            font-family: var(--font-body);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overscroll-behavior: none;
            transition: background-color 0.5s, color 0.5s;
        }
        
        #app-container {
            background: linear-gradient(-45deg, #0A0A0A, #0d1a26, #0A0A0A, #1c2b3a);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .title-font { font-family: var(--font-title); }

        .widget, .modal-pane, .timeline-item, .journal-entry {
            backdrop-filter: blur(25px) saturate(150%);
            -webkit-backdrop-filter: blur(25px) saturate(150%);
            background-color: rgba(26, 26, 26, 0.7);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .modal-pane, .page { animation: fadeIn 0.5s ease-out forwards; }
        .page.hidden { display: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Icon Animations */
        @keyframes iconPress {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.85); }
        }
        .anim-press { animation: iconPress 0.3s ease-in-out; }

        /* SortableJS Ghost Class */
        .sortable-ghost {
            opacity: 0.4;
            background: var(--surface);
        }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
        
        /* AI Assistant Styles */
        #ai-mic-btn.is-recording, #ai-input-container.is-thinking #ai-mic-btn {
            color: var(--accent);
            animation: pulse 1.5s infinite ease-in-out;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .image-preview-container {
            position: relative;
            display: inline-block;
        }
        .image-preview-container img {
            max-height: 96px; /* 6rem */
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid var(--border-color);
        }
        .image-preview-remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--surface);
            border-radius: 9999px;
            padding: 2px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: color 0.2s;
        }
        .image-preview-remove-btn:hover {
            color: var(--accent);
        }

        #ai-input-visualizer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        #ai-input-visualizer.is-active, #ai-input-container.is-thinking #ai-input-visualizer {
            opacity: 1;
        }

        #ai-input {
            background-color: #101010; /* Enforce dark background */
            color: var(--text-primary); /* Enforce white text */
        }
        
        #ai-reply-popup.is-visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        /* Memory Graph Styles */
        #memory-graph-svg { width: 100%; height: 100%; }
        .graph-node { cursor: grab; }
        .graph-node:active { cursor: grabbing; }
        .graph-node circle { fill: var(--surface); stroke: var(--accent); stroke-width: 2px; transition: all 0.2s ease-in-out; }
        .graph-node text { fill: var(--text-secondary); font-size: 12px; font-family: var(--font-body); text-anchor: middle; pointer-events: none; user-select: none; }
        .graph-node:hover circle { fill: var(--accent); transform: scale(1.1); }
        .graph-link { stroke: var(--border-color); stroke-width: 1.5px; opacity: 0.5; }
        
    </style>
</head>
<body class="overflow-hidden">

    <div id="app-container" class="h-screen w-screen">
    <div id="app-overlay" class="h-full w-full">
        <div id="app-wrapper" class="h-full w-full flex flex-col">
            <header class="w-full p-4 flex justify-between items-center z-20 flex-shrink-0">
                <h1 class="title-font text-2xl font-bold text-white">Iris Space</h1>
                <div class="flex items-center space-x-2">
                    <button id="widget-settings-btn" class="text-[var(--text-secondary)] hover:text-white p-2 rounded-full transition-colors"><i data-lucide="layout-template"></i></button>
                    <button id="search-btn" class="text-[var(--text-secondary)] hover:text-white p-2 rounded-full transition-colors"><i data-lucide="search"></i></button>
                </div>
            </header>

            <main id="main-content" class="flex-grow p-4 overflow-y-auto relative">
                <div id="homescreen-view" class="page h-full"><div id="widget-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div></div>
                <div id="timeline-view" class="page hidden"><div id="timeline-container" class="space-y-4"></div></div>
                <div id="memory-graph-view" class="page hidden h-full"><svg id="memory-graph-svg"></svg></div>
                <div id="journal-view" class="page hidden"><div id="journal-container" class="space-y-8"></div></div>
            </main>
            
            <div id="ai-input-container" class="w-full p-4 flex-shrink-0 z-10">
                <div id="ai-image-preview-container" class="w-full max-w-2xl mx-auto flex justify-center mb-2"></div>
                <div class="relative w-full max-w-2xl mx-auto">
                    <canvas id="ai-input-visualizer"></canvas>
                    <input type="text" id="ai-input" placeholder="Talk to Space..." class="relative w-full bg-[var(--surface)]/80 backdrop-blur-sm border border-[var(--border-color)] rounded-full py-3 pl-14 pr-28 text-base focus:outline-none focus:border-[var(--accent)] transition-colors">
                    <label for="ai-file-input" class="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] hover:text-[var(--accent)] p-2 rounded-full cursor-pointer z-10">
                        <i data-lucide="paperclip" class="w-6 h-6"></i>
                    </label>
                    <input type="file" id="ai-file-input" class="hidden" accept="image/*">
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center z-10">
                        <button id="ai-mic-btn" class="text-[var(--text-secondary)] hover:text-[var(--accent)] p-2 rounded-full transition-colors">
                            <i data-lucide="mic" class="w-6 h-6"></i>
                        </button>
                        <button id="ai-send-btn" class="text-[var(--text-secondary)] hover:text-[var(--accent)] p-2 rounded-full transition-colors">
                            <i data-lucide="send" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
            </div>

            <footer class="w-full p-2 flex justify-around items-center z-20 flex-shrink-0 bg-black/30 backdrop-blur-md border-t border-[var(--border-color)]">
                <button data-view="homescreen-view" class="nav-btn text-[var(--accent)] p-3 rounded-full"><i data-lucide="layout-grid"></i></button>
                <button data-view="timeline-view" class="nav-btn text-[var(--text-secondary)] p-3 rounded-full"><i data-lucide="list-ordered"></i></button>
                <button data-view="memory-graph-view" class="nav-btn text-[var(--text-secondary)] p-3 rounded-full"><i data-lucide="brain-circuit"></i></button>
                <button data-view="journal-view" class="nav-btn text-[var(--text-secondary)] p-3 rounded-full"><i data-lucide="book-open"></i></button>
            </footer>
        </div>
        
        <button id="create-moment-btn" class="fixed bottom-[140px] right-5 z-30 p-4 bg-[var(--accent)] text-black rounded-full shadow-[var(--cyan-glow)] hover:bg-cyan-200 transform hover:scale-110 transition-all duration-300">
            <i data-lucide="plus" class="w-8 h-8"></i>
        </button>

        <div id="modal-backdrop" class="hidden fixed inset-0 bg-black/60 z-40"></div>
        
        <!-- AI Reply Popup -->
        <div id="ai-reply-popup" class="fixed top-20 left-1/2 w-full max-w-sm p-4 rounded-lg shadow-lg z-[100] transition-all duration-500 opacity-0 -translate-x-1/2 -translate-y-10 pointer-events-none">
            <div class="modal-pane p-3">
                <div class="flex items-center">
                    <div class="bg-cyan-500/20 p-2 rounded-full">
                        <i data-lucide="sparkles" class="w-6 h-6 text-[var(--accent)]"></i>
                    </div>
                    <div class="ml-3">
                        <p id="ai-reply-text" class="text-sm font-medium text-[var(--text-primary)]"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODALS -->
        <div id="search-modal" class="hidden fixed inset-0 flex flex-col items-center justify-center z-50 p-4"></div>
        <div id="create-moment-modal" class="hidden fixed inset-0 flex flex-col items-center justify-center z-50 p-4"></div>
        <div id="widget-settings-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 p-4"></div>
    </div>
    </div>

    <script type="module">
        // --- INITIALIZATION ---
        const { jsPDF } = window.jspdf;
        const DB_NAME = 'IrisSpaceDB', DB_VERSION = 5;
        const MOMENTS_STORE = 'moments', WIDGET_STORE = 'widgets', SETTINGS_STORE = 'settings', TASKS_STORE = 'tasks';
        const GEMINI_API_KEY = "AIzaSyDyxl1bBC3l1kDtCyx6ZtKGb6VWwlP3tkM";
        let db, aiImageBase64 = null, aiImageMimeType = null;
        
        window.onload = async () => {
            lucide.createIcons();
            setupAIVisualizer();
            
            try {
                db = await openDB();
                updateTheme();
                renderAllModals();
                setupEventListeners();
                setupSpeechRecognition();
                await refreshApp();
                showView('homescreen-view');
            } catch (error) {
                console.error('Failed to initialize app:', error);
            }
        };

        // --- DATABASE ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject('DB Error');
                request.onsuccess = (e) => resolve(e.target.result);
                request.onupgradeneeded = (e) => {
                    let db = e.target.result;
                    if (!db.objectStoreNames.contains(MOMENTS_STORE)) db.createObjectStore(MOMENTS_STORE, { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains(WIDGET_STORE)) db.createObjectStore(WIDGET_STORE, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains(SETTINGS_STORE)) db.createObjectStore(SETTINGS_STORE, { keyPath: 'key' });
                    if (!db.objectStoreNames.contains(TASKS_STORE)) db.createObjectStore(TASKS_STORE, { keyPath: 'id', autoIncrement: true });
                };
            });
        }
        const dbAction = (storeName, mode, action) => new Promise((resolve, reject) => {
             const tx = db.transaction(storeName, mode);
             const store = tx.objectStore(storeName);
             action(store, resolve, reject);
        });

        // --- CORE & UI ---
        async function refreshApp() {
            await renderWidgets();
            await renderTimeline();
            await renderMemoryGraph();
            await renderJournal();
        }
        function showView(viewId) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('text-[var(--accent)]', btn.dataset.view === viewId);
                btn.classList.toggle('text-[var(--text-secondary)]', btn.dataset.view !== viewId);
            });
             if (viewId === 'memory-graph-view') {
                renderMemoryGraph(); // Rerender graph when view is shown
            }
        }
        function animateIcon(element) {
            if (!element) return;
            element.classList.add('anim-press');
            element.addEventListener('animationend', () => element.classList.remove('anim-press'), { once: true });
        }
        function showModal(id) { document.getElementById('modal-backdrop').classList.remove('hidden'); document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById('modal-backdrop').classList.add('hidden'); document.getElementById(id).classList.add('hidden'); }
        
        function showAIReply(shortText) {
            const popup = document.getElementById('ai-reply-popup');
            const textElement = document.getElementById('ai-reply-text');
            if (!popup || !textElement) return;

            textElement.textContent = shortText;
            popup.classList.add('is-visible');

            setTimeout(() => {
                popup.classList.remove('is-visible');
            }, 5000);
        }

        // --- MODAL RENDERING ---
        function renderAllModals() {
            document.getElementById('search-modal').innerHTML = `
                <div class="modal-pane w-full max-w-2xl max-h-[80vh] rounded-lg flex flex-col">
                    <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center"> <h2 class="title-font text-xl">Search</h2> <button id="close-search-modal" class="p-1"><i data-lucide="x"></i></button> </div>
                    <div class="p-4 border-b border-[var(--border-color)]"> <div class="relative"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-[var(--text-secondary)]"></i><input type="text" id="search-input" placeholder="Search..." class="w-full bg-transparent pl-10 pr-4 py-2 rounded-lg focus:outline-none"></div> </div>
                    <div id="search-results" class="flex-grow overflow-y-auto p-4 space-y-3"></div>
                </div>`;
            document.getElementById('create-moment-modal').innerHTML = `
                <div class="modal-pane w-full max-w-md rounded-lg flex flex-col">
                    <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center"> <h2 class="title-font text-xl">Create Moment</h2> <button id="close-create-moment-modal" class="p-1"><i data-lucide="x"></i></button> </div>
                    <div class="p-4 space-y-4">
                        <div id="moment-image-preview-container" class="w-full flex justify-center mb-2"></div>
                        <textarea id="moment-text-input" placeholder="What's on your mind?" class="w-full h-24 bg-transparent p-2 rounded border border-[var(--border-color)] focus:outline-none focus:border-[var(--accent)]"></textarea>
                        <input type="text" id="moment-tags-input" placeholder="Tags (comma separated)" class="w-full bg-transparent p-2 rounded border border-[var(--border-color)] focus:outline-none focus:border-[var(--accent)]">
                        <div class="flex justify-between items-center">
                             <label for="moment-file-input" class="cursor-pointer p-2 rounded border border-[var(--border-color)] hover:border-[var(--accent)]"><i data-lucide="paperclip" class="inline"></i> Attach</label> <input type="file" id="moment-file-input" class="hidden" accept="image/*,video/*">
                             <button id="record-audio-btn" class="p-2 rounded border border-[var(--border-color)] hover:border-[var(--accent)] transition-all"><i data-lucide="mic" class="inline"></i> Record</button>
                        </div>
                    </div>
                    <div class="p-4 border-t border-[var(--border-color)] text-right"> <button id="save-moment-btn" class="px-4 py-2 bg-[var(--accent)] text-black rounded font-semibold hover:opacity-80 transition">Save</button> </div>
                </div>`;
            document.getElementById('widget-settings-modal').innerHTML = `
                <div class="modal-pane w-full max-w-2xl rounded-lg flex flex-col max-h-[80vh]">
                    <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center"> <h2 class="title-font text-xl">Manage Widgets</h2> <button id="close-widget-settings-modal" class="p-1"><i data-lucide="x"></i></button> </div>
                    <div class="flex-grow overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div> <h3 class="font-semibold mb-2">Active Widgets</h3> <div id="active-widgets-list" class="min-h-[200px] bg-[var(--bg-secondary)] p-2 rounded-md space-y-2"></div> </div>
                        <div> <h3 class="font-semibold mb-2">Available Widgets</h3> <div id="available-widgets-list" class="min-h-[200px] bg-[var(--bg-secondary)] p-2 rounded-md space-y-2"></div> </div>
                    </div>
                    <div class="p-4 border-t border-[var(--border-color)] text-right"> <button id="save-widgets-btn" class="px-4 py-2 bg-[var(--accent)] text-black rounded font-semibold hover:opacity-80 transition">Save & Close</button> </div>
                </div>`;
            lucide.createIcons();
        }
        
        // --- THEME ---
        function updateTheme() {
            document.documentElement.classList.add('dark');
            lucide.createIcons


