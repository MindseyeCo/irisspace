<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Iris Space</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0A0A0A">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/0891b2/ffffff?text=IS">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600&family=Playfair+Display:wght@700&display=swap');
        
        :root {
            --cyan-glow: 0 0 8px rgba(34, 211, 238, 0.6), 0 0 16px rgba(34, 211, 238, 0.4), 0 0 24px rgba(34, 211, 238, 0.2);
        }

        .dark {
            --bg-primary: #0A0A0A;
            --bg-secondary: #101010;
            --surface: #1A1A1A;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --accent: #22D3EE; /* Brighter Cyan */
            --accent-light: #A5F3FC;
            --border-color: #2A2A2A; /* Corrected border color */
            --font-body: 'Sora', sans-serif;
            --font-title: 'Playfair Display', serif;
        }
        
        body {
            font-family: var(--font-body);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overscroll-behavior: none;
            transition: background-color 0.5s, color 0.5s;
        }
        
        #app-container {
            background: linear-gradient(-45deg, #0A0A0A, #0d1a26, #0A0A0A, #1c2b3a);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .title-font { font-family: var(--font-title); }

        .widget, .modal-pane, .timeline-item, .journal-entry {
            backdrop-filter: blur(25px) saturate(150%);
            -webkit-backdrop-filter: blur(25px) saturate(150%);
            background-color: rgba(26, 26, 26, 0.7);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .modal-pane, .page { animation: fadeIn 0.5s ease-out forwards; }
        .page.hidden { display: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Icon Animations */
        @keyframes iconPress {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.85); }
        }
        .anim-press { animation: iconPress 0.3s ease-in-out; }

        /* SortableJS Ghost Class */
        .sortable-ghost {
            opacity: 0.4;
            background: var(--surface);
        }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
        
        /* AI Assistant Styles */
        #ai-mic-btn.is-recording, #ai-input-container.is-thinking #ai-mic-btn {
            color: var(--accent);
            animation: pulse 1.5s infinite ease-in-out;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .image-preview-container {
            position: relative;
            display: inline-block;
        }
        .image-preview-container img {
            max-height: 96px; /* 6rem */
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid var(--border-color);
        }
        .image-preview-remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--surface);
            border-radius: 9999px;
            padding: 2px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: color 0.2s;
        }
        .image-preview-remove-btn:hover {
            color: var(--accent);
        }

        #ai-input-visualizer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        #ai-input-visualizer.is-active, #ai-input-container.is-thinking #ai-input-visualizer {
            opacity: 1;
        }

        #ai-input {
            background-color: #101010; /* Enforce dark background */
            color: var(--text-primary); /* Enforce white text */
        }
        
        #ai-reply-popup.is-visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        /* Memory Graph Styles */
        #memory-graph-svg { width: 100%; height: 100%; }
        .graph-node { cursor: grab; }
        .graph-node:active { cursor: grabbing; }
        .graph-node circle { fill: var(--surface); stroke: var(--accent); stroke-width: 2px; transition: all 0.2s ease-in-out; }
        .graph-node text { fill: var(--text-secondary); font-size: 12px; font-family: var(--font-body); text-anchor: middle; pointer-events: none; user-select: none; }
        .graph-node:hover circle { fill: var(--accent); transform: scale(1.1); }
        .graph-link { stroke: var(--border-color); stroke-width: 1.5px; opacity: 0.5; }
        
    </style>
</head>
<body class="overflow-hidden">

    <div id="app-container" class="h-screen w-screen">
    <div id="app-overlay" class="h-full w-full">
        <div id="app-wrapper" class="h-full w-full flex flex-col">
            <header class="w-full p-4 flex justify-between items-center z-20 flex-shrink-0">
                <h1 class="title-font text-2xl font-bold text-white">Iris Space</h1>
                <div class="flex items-center space-x-2">
                    <button id="widget-settings-btn" class="text-[var(--text-secondary)] hover:text-white p-2 rounded-full transition-colors"><i data-lucide="layout-template"></i></button>
                    <button id="search-btn" class="text-[var(--text-secondary)] hover:text-white p-2 rounded-full transition-colors"><i data-lucide="search"></i></button>
                </div>
            </header>

            <main id="main-content" class="flex-grow p-4 overflow-y-auto relative">
                <div id="homescreen-view" class="page h-full"><div id="widget-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div></div>
                <div id="timeline-view" class="page hidden"><div id="timeline-container" class="space-y-4"></div></div>
                <div id="memory-graph-view" class="page hidden h-full"><svg id="memory-graph-svg"></svg></div>
                <div id="journal-view" class="page hidden"><div id="journal-container" class="space-y-8"></div></div>
            </main>
            
            <div id="ai-input-container" class="w-full p-4 flex-shrink-0 z-10">
                <div id="ai-image-preview-container" class="w-full max-w-2xl mx-auto flex justify-center mb-2"></div>
                <div class="relative w-full max-w-2xl mx-auto">
                    <canvas id="ai-input-visualizer"></canvas>
                    <input type="text" id="ai-input" placeholder="Talk to Space..." class="relative w-full bg-[var(--surface)]/80 backdrop-blur-sm border border-[var(--border-color)] rounded-full py-3 pl-14 pr-28 text-base focus:outline-none focus:border-[var(--accent)] transition-colors">
                    <label for="ai-file-input" class="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] hover:text-[var(--accent)] p-2 rounded-full cursor-pointer z-10">
                        <i data-lucide="paperclip" class="w-6 h-6"></i>
                    </label>
                    <input type="file" id="ai-file-input" class="hidden" accept="image/*">
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center z-10">
                        <button id="ai-mic-btn" class="text-[var(--text-secondary)] hover:text-[var(--accent)] p-2 rounded-full transition-colors">
                            <i data-lucide="mic" class="w-6 h-6"></i>
                        </button>
                        <button id="ai-send-btn" class="text-[var(--text-secondary)] hover:text-[var(--accent)] p-2 rounded-full transition-colors">
                            <i data-lucide="send" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
            </div>

            <footer class="w-full p-2 flex justify-around items-center z-20 flex-shrink-0 bg-black/30 backdrop-blur-md border-t border-[var(--border-color)]">
                <button data-view="homescreen-view" class="nav-btn text-[var(--accent)] p-3 rounded-full"><i data-lucide="layout-grid"></i></button>
                <button data-view="timeline-view" class="nav-btn text-[var(--text-secondary)] p-3 rounded-full"><i data-lucide="list-ordered"></i></button>
                <button data-view="memory-graph-view" class="nav-btn text-[var(--text-secondary)] p-3 rounded-full"><i data-lucide="brain-circuit"></i></button>
                <button data-view="journal-view" class="nav-btn text-[var(--text-secondary)] p-3 rounded-full"><i data-lucide="book-open"></i></button>
            </footer>
        </div>
        
        <button id="create-moment-btn" class="fixed bottom-[140px] right-5 z-30 p-4 bg-[var(--accent)] text-black rounded-full shadow-[var(--cyan-glow)] hover:bg-cyan-200 transform hover:scale-110 transition-all duration-300">
            <i data-lucide="plus" class="w-8 h-8"></i>
        </button>

        <div id="modal-backdrop" class="hidden fixed inset-0 bg-black/60 z-40"></div>
        
        <!-- AI Reply Popup -->
        <div id="ai-reply-popup" class="fixed top-20 left-1/2 w-full max-w-sm p-4 rounded-lg shadow-lg z-[100] transition-all duration-500 opacity-0 -translate-x-1/2 -translate-y-10 pointer-events-none">
            <div class="modal-pane p-3">
                <div class="flex items-center">
                    <div class="bg-cyan-500/20 p-2 rounded-full">
                        <i data-lucide="sparkles" class="w-6 h-6 text-[var(--accent)]"></i>
                    </div>
                    <div class="ml-3">
                        <p id="ai-reply-text" class="text-sm font-medium text-[var(--text-primary)]"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODALS -->
        <div id="search-modal" class="hidden fixed inset-0 flex flex-col items-center justify-center z-50 p-4"></div>
        <div id="create-moment-modal" class="hidden fixed inset-0 flex flex-col items-center justify-center z-50 p-4"></div>
        <div id="widget-settings-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 p-4"></div>
    </div>
    </div>

    <script type="module">
        // --- INITIALIZATION ---
        const { jsPDF } = window.jspdf;
        const DB_NAME = 'IrisSpaceDB', DB_VERSION = 5;
        const MOMENTS_STORE = 'moments', WIDGET_STORE = 'widgets', SETTINGS_STORE = 'settings', TASKS_STORE = 'tasks';
        const GEMINI_API_KEY = "AIzaSyDyxl1bBC3l1kDtCyx6ZtKGb6VWwlP3tkM";
        let db, aiImageBase64 = null, aiImageMimeType = null;
        
        window.onload = async () => {
            lucide.createIcons();
            setupAIVisualizer();
            
            try {
                db = await openDB();
                updateTheme();
                renderAllModals();
                setupEventListeners();
                setupSpeechRecognition();
                await refreshApp();
                showView('homescreen-view');
            } catch (error) {
                console.error('Failed to initialize app:', error);
            }
        };

        // --- DATABASE ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject('DB Error');
                request.onsuccess = (e) => resolve(e.target.result);
                request.onupgradeneeded = (e) => {
                    let db = e.target.result;
                    if (!db.objectStoreNames.contains(MOMENTS_STORE)) db.createObjectStore(MOMENTS_STORE, { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains(WIDGET_STORE)) db.createObjectStore(WIDGET_STORE, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains(SETTINGS_STORE)) db.createObjectStore(SETTINGS_STORE, { keyPath: 'key' });
                    if (!db.objectStoreNames.contains(TASKS_STORE)) db.createObjectStore(TASKS_STORE, { keyPath: 'id', autoIncrement: true });
                };
            });
        }
        const dbAction = (storeName, mode, action) => new Promise((resolve, reject) => {
             const tx = db.transaction(storeName, mode);
             const store = tx.objectStore(storeName);
             action(store, resolve, reject);
        });

        // --- CORE & UI ---
        async function refreshApp() {
            await renderWidgets();
            await renderTimeline();
            await renderMemoryGraph();
            await renderJournal();
        }
        function showView(viewId) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('text-[var(--accent)]', btn.dataset.view === viewId);
                btn.classList.toggle('text-[var(--text-secondary)]', btn.dataset.view !== viewId);
            });
             if (viewId === 'memory-graph-view') {
                renderMemoryGraph(); // Rerender graph when view is shown
            }
        }
        function animateIcon(element) {
            if (!element) return;
            element.classList.add('anim-press');
            element.addEventListener('animationend', () => element.classList.remove('anim-press'), { once: true });
        }
        function showModal(id) { document.getElementById('modal-backdrop').classList.remove('hidden'); document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById('modal-backdrop').classList.add('hidden'); document.getElementById(id).classList.add('hidden'); }
        
        function showAIReply(shortText) {
            const popup = document.getElementById('ai-reply-popup');
            const textElement = document.getElementById('ai-reply-text');
            if (!popup || !textElement) return;

            textElement.textContent = shortText;
            popup.classList.add('is-visible');

            setTimeout(() => {
                popup.classList.remove('is-visible');
            }, 5000);
        }

        // --- MODAL RENDERING ---
        function renderAllModals() {
            document.getElementById('search-modal').innerHTML = `
                <div class="modal-pane w-full max-w-2xl max-h-[80vh] rounded-lg flex flex-col">
                    <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center"> <h2 class="title-font text-xl">Search</h2> <button id="close-search-modal" class="p-1"><i data-lucide="x"></i></button> </div>
                    <div class="p-4 border-b border-[var(--border-color)]"> <div class="relative"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-[var(--text-secondary)]"></i><input type="text" id="search-input" placeholder="Search..." class="w-full bg-transparent pl-10 pr-4 py-2 rounded-lg focus:outline-none"></div> </div>
                    <div id="search-results" class="flex-grow overflow-y-auto p-4 space-y-3"></div>
                </div>`;
            document.getElementById('create-moment-modal').innerHTML = `
                <div class="modal-pane w-full max-w-md rounded-lg flex flex-col">
                    <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center"> <h2 class="title-font text-xl">Create Moment</h2> <button id="close-create-moment-modal" class="p-1"><i data-lucide="x"></i></button> </div>
                    <div class="p-4 space-y-4">
                        <div id="moment-image-preview-container" class="w-full flex justify-center mb-2"></div>
                        <textarea id="moment-text-input" placeholder="What's on your mind?" class="w-full h-24 bg-transparent p-2 rounded border border-[var(--border-color)] focus:outline-none focus:border-[var(--accent)]"></textarea>
                        <input type="text" id="moment-tags-input" placeholder="Tags (comma separated)" class="w-full bg-transparent p-2 rounded border border-[var(--border-color)] focus:outline-none focus:border-[var(--accent)]">
                        <div class="flex justify-between items-center">
                             <label for="moment-file-input" class="cursor-pointer p-2 rounded border border-[var(--border-color)] hover:border-[var(--accent)]"><i data-lucide="paperclip" class="inline"></i> Attach</label> <input type="file" id="moment-file-input" class="hidden" accept="image/*,video/*">
                             <button id="record-audio-btn" class="p-2 rounded border border-[var(--border-color)] hover:border-[var(--accent)] transition-all"><i data-lucide="mic" class="inline"></i> Record</button>
                        </div>
                    </div>
                    <div class="p-4 border-t border-[var(--border-color)] text-right"> <button id="save-moment-btn" class="px-4 py-2 bg-[var(--accent)] text-black rounded font-semibold hover:opacity-80 transition">Save</button> </div>
                </div>`;
            document.getElementById('widget-settings-modal').innerHTML = `
                <div class="modal-pane w-full max-w-2xl rounded-lg flex flex-col max-h-[80vh]">
                    <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center"> <h2 class="title-font text-xl">Manage Widgets</h2> <button id="close-widget-settings-modal" class="p-1"><i data-lucide="x"></i></button> </div>
                    <div class="flex-grow overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div> <h3 class="font-semibold mb-2">Active Widgets</h3> <div id="active-widgets-list" class="min-h-[200px] bg-[var(--bg-secondary)] p-2 rounded-md space-y-2"></div> </div>
                        <div> <h3 class="font-semibold mb-2">Available Widgets</h3> <div id="available-widgets-list" class="min-h-[200px] bg-[var(--bg-secondary)] p-2 rounded-md space-y-2"></div> </div>
                    </div>
                    <div class="p-4 border-t border-[var(--border-color)] text-right"> <button id="save-widgets-btn" class="px-4 py-2 bg-[var(--accent)] text-black rounded font-semibold hover:opacity-80 transition">Save & Close</button> </div>
                </div>`;
            lucide.createIcons();
        }
        
        // --- THEME ---
        function updateTheme() {
            document.documentElement.classList.add('dark');
            lucide.createIcons();
        }
        
        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.body.addEventListener('click', e => {
                const navBtn = e.target.closest('.nav-btn');
                if (navBtn) {
                    showView(navBtn.dataset.view);
                    animateIcon(navBtn);
                }
                const deleteBtn = e.target.closest('.delete-moment-btn');
                if (deleteBtn) {
                    const momentId = parseInt(deleteBtn.dataset.momentId, 10);
                    deleteMoment(momentId);
                }
                 const taskCheckbox = e.target.closest('.task-checkbox');
                if(taskCheckbox) {
                    toggleTaskCompletion(parseInt(taskCheckbox.dataset.taskId), taskCheckbox.checked);
                }
            });

            document.getElementById('search-btn').addEventListener('click', () => showModal('search-modal'));
            document.getElementById('create-moment-btn').addEventListener('click', () => showModal('create-moment-modal'));
            document.getElementById('widget-settings-btn').addEventListener('click', () => { showModal('widget-settings-modal'); populateWidgetModal(); });
            document.getElementById('modal-backdrop').addEventListener('click', () => { closeModal('search-modal'); closeModal('create-moment-modal'); closeModal('widget-settings-modal'); });

            // Modal specific listeners
            document.getElementById('close-search-modal').addEventListener('click', () => closeModal('search-modal'));
            document.getElementById('close-create-moment-modal').addEventListener('click', () => closeModal('create-moment-modal'));
            document.getElementById('save-moment-btn').addEventListener('click', saveMoment);
            document.getElementById('moment-file-input').addEventListener('change', handleMomentFileSelect);
            document.getElementById('record-audio-btn').addEventListener('click', toggleAudioRecording);

            document.getElementById('close-widget-settings-modal').addEventListener('click', () => closeModal('widget-settings-modal'));
            document.getElementById('save-widgets-btn').addEventListener('click', saveWidgetLayout);
            
            // AI Input
            document.getElementById('ai-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') processCommand(e.target.value); });
            document.getElementById('ai-send-btn').addEventListener('click', () => {
                processCommand(document.getElementById('ai-input').value);
                animateIcon(document.querySelector('#ai-send-btn i'));
            });
            document.getElementById('ai-file-input').addEventListener('change', handleAIFileSelect);
        }

        // --- MOMENTS & MEDIA ---
        let mediaRecorder, audioChunks = [], audioBlob = null;
        async function toggleAudioRecording() {
            const recordBtn = document.getElementById('record-audio-btn');
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = []; audioBlob = null;
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.onstop = () => {
                        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        stream.getTracks().forEach(track => track.stop());
                        recordBtn.innerHTML = '<i data-lucide="mic" class="inline"></i> Record';
                        recordBtn.classList.remove('bg-red-500', 'text-white');
                        lucide.createIcons();
                    };
                    mediaRecorder.start();
                    recordBtn.innerHTML = '<i data-lucide="stop-circle" class="inline"></i> Stop';
                    recordBtn.classList.add('bg-red-500', 'text-white');
                    lucide.createIcons();
                } catch (err) { console.error("Mic error:", err); }
            }
        }
        async function saveMoment() {
             const text = document.getElementById('moment-text-input').value;
             const tags = document.getElementById('moment-tags-input').value.split(',').map(t => t.trim()).filter(Boolean);
             const file = document.getElementById('moment-file-input').files[0];
             if (!text && !file && !audioBlob) return;

             let moment = { timestamp: Date.now(), text, tags, mood: 'neutral' };
             if (audioBlob) {
                 moment = {...moment, type: 'audio', mediaType: audioBlob.type, data: audioBlob };
             } else if (file) {
                 moment = {...moment, type: file.type.startsWith('image') ? 'image' : 'video', mediaType: file.type, data: file };
             } else {
                 moment = {...moment, type: 'text' };
             }
             
             await dbAction(MOMENTS_STORE, 'readwrite', (s, res) => s.add(moment).onsuccess = res);
             closeModal('create-moment-modal');
             document.getElementById('moment-text-input').value = '';
             document.getElementById('moment-tags-input').value = '';
             document.getElementById('moment-file-input').value = '';
             document.getElementById('moment-image-preview-container').innerHTML = '';
             audioBlob = null;
             refreshApp();
        }
        async function renderTimeline() {
             const container = document.getElementById('timeline-container');
             container.innerHTML = `<h2 class="title-font text-3xl font-bold mb-6">Timeline</h2>`;
             const moments = await dbAction(MOMENTS_STORE, 'readonly', (store, resolve) => store.getAll().onsuccess = e => resolve(e.target.result.sort((a,b) => b.timestamp - a.timestamp)));
             if(moments.length === 0) { container.innerHTML += `<div class="text-center mt-20 text-[var(--text-secondary)]"><i data-lucide="moon-star" class="w-16 h-16 mx-auto"></i><p class="mt-4">Your space is clear.</p></div>`; lucide.createIcons(); return; }
             
             moments.forEach(m => {
                 let mediaContent = '';
                 if (m.data) {
                     const mediaUrl = URL.createObjectURL(m.data);
                     if (m.type === 'image') mediaContent = `<img src="${mediaUrl}" class="mt-2 rounded-lg max-h-60 w-auto">`;
                     if (m.type === 'video') mediaContent = `<video controls src="${mediaUrl}" class="mt-2 rounded-lg w-full"></video>`;
                     if (m.type === 'audio') mediaContent = `<audio controls src="${mediaUrl}" class="w-full mt-2"></audio>`;
                 }
                 const item = document.createElement('div');
                 item.className = 'timeline-item p-4 rounded-lg relative';
                 item.innerHTML = `
                    <button class="delete-moment-btn absolute top-2 right-2 p-1 text-[var(--text-secondary)] hover:text-red-500 transition-colors" data-moment-id="${m.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    <p class="whitespace-pre-wrap">${m.text || ''}</p> 
                    ${mediaContent}
                    <div class="text-xs text-[var(--text-secondary)] mt-2">${new Date(m.timestamp).toLocaleString()}</div>`;
                 container.appendChild(item);
             });
             lucide.createIcons();
        }
        async function deleteMoment(momentId) {
            await dbAction(MOMENTS_STORE, 'readwrite', (s, res) => s.delete(momentId).onsuccess = res);
            await refreshApp();
        }
        function handleMomentFileSelect(event) {
            const file = event.target.files[0];
            const container = document.getElementById('moment-image-preview-container');
            if (!file || !file.type.startsWith('image/')) { container.innerHTML = ''; return; }
            const reader = new FileReader();
            reader.onloadend = () => container.innerHTML = `<div class="image-preview-container"><img src="${reader.result}" alt="Preview"></div>`;
            reader.readAsDataURL(file);
        }

        // --- WIDGETS ---
        const ALL_WIDGETS = {
            clock: { name: "Clock", render: () => `<div class="text-4xl font-bold">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>` },
            weather: { name: "Weather", render: async () => { 
                const data = await getWeatherData();
                return `<i data-lucide="${data.icon}" class="w-12 h-12 mx-auto"></i><p class="text-3xl font-bold">${data.temp}Â°</p><p>${data.city}</p>`;
            }},
            tasks: { name: "Tasks", render: async () => {
                const tasks = await dbAction(TASKS_STORE, 'readonly', (s, res) => s.getAll().onsuccess = e => res(e.target.result));
                if (!tasks || tasks.length === 0) return '<p class="text-[var(--text-secondary)]">No tasks yet.</p>';
                return `<ul class="space-y-2 text-left w-full">${tasks.map(t => `<li class="flex items-center"><input type="checkbox" data-task-id="${t.id}" class="task-checkbox mr-2 accent-[var(--accent)]" ${t.completed ? 'checked' : ''}><span class="${t.completed ? 'line-through text-[var(--text-secondary)]' : ''}">${t.text}</span></li>`).join('')}</ul>`;
            }},
            dailyQuote: { name: "Daily Quote", render: () => {
                const quotes = [
                    "The journey of a thousand miles begins with a single step.",
                    "That which does not kill us makes us stronger.",
                    "The only thing we have to fear is fear itself.",
                    "Strive not to be a success, but rather to be of value.",
                    "The best way to predict the future is to create it."
                ];
                const today = new Date().getDate(); // Use day of month to pick a quote
                return `<p class="text-sm italic">"${quotes[today % quotes.length]}"</p>`;
            }},
            onThisDay: { name: "On This Day", render: async () => {
                const moments = await dbAction(MOMENTS_STORE, 'readonly', (s, res) => s.getAll().onsuccess = e => res(e.target.result));
                const today = new Date();
                const todayMonth = today.getMonth();
                const todayDate = today.getDate();
                const pastMoments = moments.filter(m => {
                    const momentDate = new Date(m.timestamp);
                    return momentDate.getFullYear() < today.getFullYear() &&
                           momentDate.getMonth() === todayMonth &&
                           momentDate.getDate() === todayDate;
                });
                if (pastMoments.length === 0) {
                    return `<p class="text-[var(--text-secondary)] text-sm">No memories from this day in the past.</p>`;
                }
                const randomPastMoment = pastMoments[Math.floor(Math.random() * pastMoments.length)];
                const year = new Date(randomPastMoment.timestamp).getFullYear();
                return `<div class="text-left text-sm w-full"><p class="font-bold mb-1">From ${year}:</p><p class="truncate">${randomPastMoment.text || 'Media moment'}</p></div>`;
            }},
            recentImage: { name: "Recent Image", render: async () => {
                const moments = await dbAction(MOMENTS_STORE, 'readonly', (s, res) => s.getAll().onsuccess = e => res(e.target.result));
                const latestImageMoment = moments.filter(m => m.type === 'image').sort((a,b) => b.timestamp - a.timestamp)[0];
                if (!latestImageMoment) {
                    return `<i data-lucide="image-off" class="w-10 h-10 mx-auto text-[var(--text-secondary)]"></i>`;
                }
                const url = URL.createObjectURL(latestImageMoment.data);
                return `<img src="${url}" class="w-full h-full object-cover rounded-md absolute inset-0">`;
            }},
            location: { name: "Location", render: async () => {
                const data = await getLocationData();
                return `<i data-lucide="map-pin" class="w-10 h-10 mx-auto"></i><p class="font-bold text-lg">${data.city}</p><p class="text-xs">${data.coords}</p>`;
            }}
        };
        async function getWeatherData() { return { temp: 72, city: 'Rocklin', icon: 'sun' }; }
        async function getLocationData() { return new Promise(resolve => navigator.geolocation.getCurrentPosition(pos => resolve({ city: 'Rocklin', coords: `${pos.coords.latitude.toFixed(2)}, ${pos.coords.longitude.toFixed(2)}`}), () => resolve({ city: 'Unknown', coords: 'N/A' }))); }
        async function renderWidgets() {
            const grid = document.getElementById('widget-grid');
            grid.innerHTML = '';
            let userWidgets = (await dbAction(WIDGET_STORE, 'readonly', (s, res) => s.get('layout').onsuccess = e => res(e.target.result?.value))) || ['clock', 'weather', 'tasks'];
            
            for(const widgetId of userWidgets) {
                const widgetDef = ALL_WIDGETS[widgetId];
                if (!widgetDef) continue;
                const widgetEl = document.createElement('div');
                widgetEl.className = 'widget p-4 rounded-lg col-span-1 row-span-1 min-h-[120px] flex items-center justify-center';
                if (widgetId === 'recentImage') {
                    widgetEl.className += ' relative p-0 overflow-hidden';
                }
                widgetEl.dataset.widgetId = widgetId;
                widgetEl.innerHTML = `<div class="text-center w-full">${await widgetDef.render()}</div>`;
                grid.appendChild(widgetEl);
            }
            lucide.createIcons();
            if (grid.children.length > 0) {
              Sortable.create(grid, { animation: 150, ghostClass: 'sortable-ghost', onEnd: saveWidgetOrder });
            }
        }
        async function toggleTaskCompletion(taskId, isCompleted) {
            const tx = db.transaction(TASKS_STORE, 'readwrite');
            const store = tx.objectStore(TASKS_STORE);
            const request = store.get(taskId);
            request.onsuccess = () => {
                const task = request.result;
                if(task) {
                    task.completed = isCompleted;
                    store.put(task);
                }
            };
            tx.oncomplete = () => renderWidgets();
        }
        async function populateWidgetModal() {
            const activeList = document.getElementById('active-widgets-list');
            const availableList = document.getElementById('available-widgets-list');
            activeList.innerHTML = ''; availableList.innerHTML = '';
            const userWidgets = (await dbAction(WIDGET_STORE, 'readonly', (s, res) => s.get('layout').onsuccess = e => res(e.target.result?.value))) || ['clock', 'weather', 'tasks'];
            Object.keys(ALL_WIDGETS).forEach(id => {
                const item = document.createElement('div');
                item.className = 'p-2 bg-[var(--surface)] rounded cursor-move';
                item.textContent = ALL_WIDGETS[id].name;
                item.dataset.widgetId = id;
                if (userWidgets.includes(id)) activeList.appendChild(item);
                else availableList.appendChild(item);
            });
            Sortable.create(activeList, { group: 'widgets', animation: 150, ghostClass: 'sortable-ghost' });
            Sortable.create(availableList, { group: 'widgets', animation: 150, ghostClass: 'sortable-ghost' });
        }
        async function saveWidgetLayout() {
            const activeWidgets = Array.from(document.getElementById('active-widgets-list').children).map(el => el.dataset.widgetId);
            await dbAction(WIDGET_STORE, 'readwrite', (s, res) => s.put({ id: 'layout', value: activeWidgets }).onsuccess = res);
            closeModal('widget-settings-modal');
            await renderWidgets();
        }
        async function saveWidgetOrder(evt) {
            const newOrder = Array.from(evt.target.children).map(el => el.dataset.widgetId);
            await dbAction(WIDGET_STORE, 'readwrite', (s, res) => s.put({ id: 'layout', value: newOrder }).onsuccess = res);
        }

        // --- AI ASSISTANT, SPEECH & VISUALIZER ---
        let recognition, audioContext, analyser, micStream;
        function setupSpeechRecognition() {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const micBtn = document.getElementById('ai-mic-btn');
            const visualizer = document.getElementById('ai-input-visualizer');
            if (!window.SpeechRecognition) {
                if(micBtn) micBtn.style.display = 'none';
                return;
            }
            try {
                recognition = new window.SpeechRecognition();
                recognition.continuous = false; recognition.lang = 'en-US'; recognition.interimResults = false;
                
                recognition.onstart = () => {
                    micBtn.classList.add('is-recording');
                    visualizer.classList.add('is-active');
                };
                recognition.onend = () => {
                    micBtn.classList.remove('is-recording');
                    visualizer.classList.remove('is-active');
                    if (micStream) micStream.getTracks().forEach(track => track.stop());
                    if (audioContext && audioContext.state !== 'closed') audioContext.close();
                    analyser = null;
                };
                recognition.onerror = recognition.onend;
                recognition.onresult = (e) => {
                    document.getElementById('ai-input').value = e.results[0][0].transcript;
                };

                micBtn.addEventListener('click', async () => {
                    if (recognition && (micBtn.classList.contains('is-recording'))) {
                        recognition.stop();
                        return;
                    }
                    try {
                        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        analyser = audioContext.createAnalyser();
                        const source = audioContext.createMediaStreamSource(micStream);
                        source.connect(analyser);
                        recognition.start();
                    } catch (err) {
                        console.error("Mic/Audio context error:", err);
                    }
                });
            } catch(e) {
                if(micBtn) micBtn.style.display = 'none';
            }
        }
        function setupAIVisualizer() {
            const canvas = document.getElementById('ai-input-visualizer');
            const ctx = canvas.getContext('2d');
            let particles = [];
            const particleCount = 30;
            const colors = ["#22D3EE", "#A5F3FC", "#FFFFFF"];
            
            class Particle {
                constructor() {
                    this.x = canvas.width / 2;
                    this.y = canvas.height / 2;
                    this.angle = Math.random() * Math.PI * 2;
                    this.radius = Math.random() * 2 + 1;
                    this.color = colors[Math.floor(Math.random() * colors.length)];
                    this.speed = Math.random() * 2 + 0.5;
                    this.orbitRadius = Math.random() * (canvas.width * 0.4) + (canvas.width * 0.1);
                }
                update(audioLevel) {
                    this.angle += this.speed / 100;
                    const effectiveOrbit = this.orbitRadius + (audioLevel * this.orbitRadius * 0.2);
                    this.x = canvas.width / 2 + Math.cos(this.angle) * effectiveOrbit;
                    this.y = canvas.height / 2 + Math.sin(this.angle) * effectiveOrbit;
                    this.radius = Math.max(1, this.radius + (audioLevel * 5 - 0.5));
                }
                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = this.color;
                    ctx.fill();
                }
            }

            function resize() {
                const container = canvas.parentElement;
                if (!container) return;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                particles = [];
                 for(let i=0; i < particleCount; i++) {
                    particles.push(new Particle());
                }
            }
            window.addEventListener('resize', resize);
            resize();
            
            function animate() {
                if (canvas.parentElement && canvas.parentElement.clientWidth !== canvas.width) resize();

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let audioLevel = 0;
                const isThinking = document.getElementById('ai-input-container')?.classList.contains('is-thinking');

                if (analyser) { // voice input is active
                    const dataArray = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteTimeDomainData(dataArray);
                    let sum = 0;
                    for(const amp of dataArray) {
                        sum += (amp - 128) * (amp - 128);
                    }
                    audioLevel = Math.sqrt(sum / dataArray.length) / 100;
                } else if (isThinking) { // AI is processing
                    // Create a synthetic "breathing" effect
                    const time = Date.now() * 0.002;
                    audioLevel = (Math.sin(time) * 0.5 + 0.5) * 0.5; // Oscillates between 0 and 0.5
                }

                ctx.filter = 'blur(5px)';
                particles.forEach(p => {
                    p.update(audioLevel);
                    p.draw();
                });
                ctx.filter = 'none';

                requestAnimationFrame(animate);
            }
            animate();
        }
        function handleAIFileSelect(event) {
            const file = event.target.files[0];
            const container = document.getElementById('ai-image-preview-container');
            const reset = () => {
                container.innerHTML = ''; aiImageBase64 = null; aiImageMimeType = null;
                document.getElementById('ai-file-input').value = '';
            };
            reset();
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onloadend = () => {
                aiImageBase64 = reader.result.split(',')[1];
                aiImageMimeType = file.type;
                container.innerHTML = `
                    <div class="image-preview-container">
                        <img src="${reader.result}" alt="Preview">
                        <button id="ai-image-preview-remove-btn" class="image-preview-remove-btn"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>`;
                lucide.createIcons();
                document.getElementById('ai-image-preview-remove-btn').addEventListener('click', reset);
            };
            reader.readAsDataURL(file);
        }
        async function processCommand(commandText) {
            const aiInputContainer = document.getElementById('ai-input-container');
            const aiInput = document.getElementById('ai-input');
            if (!commandText.trim()) return;
            const originalPlaceholder = aiInput.placeholder;
            aiInput.placeholder = "Thinking..."; aiInput.disabled = true;
            aiInputContainer.classList.add('is-thinking');

            let parts = [{ "text": commandText }];
            if (aiImageBase64 && aiImageMimeType) {
                parts.push({ "inlineData": { "mimeType": aiImageMimeType, "data": aiImageBase64 } });
            }
            
            const systemPrompt = `You are an AI assistant for an app called Iris Space. Your goal is to interpret user commands and respond in a specific JSON format.
                Available intents: 'create_task', 'delete_task', 'create_note', 'image_query', 'summarize_day', 'general_query'.
                - create_task: For tasks or reminders. JSON: {"intent": "create_task", "details": {"text": "call mom", "short_reply": "Task added: call mom"}}
                - delete_task: For deleting tasks. JSON: {"intent": "delete_task", "details": {"text": "grocery", "short_reply": "Task deleted."}}
                - create_note: For general statements/ideas. JSON: {"intent": "create_note", "details": {"full_response": "had a great idea...", "short_reply": "Note saved."}}
                - image_query: For questions about an attached image. Your full_response should describe the image. JSON: {"intent": "image_query", "details": {"full_response": "A close-up of a sunflower...", "short_reply": "It's a sunflower."}}
                - summarize_day: For summarizing the user's day. JSON: {"intent": "summarize_day", "details": {"date": "today"}}
                - general_query: For all other questions/requests. The user's query is the text. JSON: {"intent": "general_query", "details": {"text": "what's the capital of France?"}}
                Respond ONLY with the JSON object.`;

            const payload = {
                "contents": [{"parts": parts}],
                "systemInstruction": { "parts": [{"text": systemPrompt }] }
            };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const rawJson = result.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                handleAIResponse(JSON.parse(rawJson));
            } catch (error) {
                console.error("Error processing AI command:", error);
                showAIReply("Sorry, I couldn't process that.");
            } finally {
                aiInput.value = ''; aiInput.disabled = false;
                aiInputContainer.classList.remove('is-thinking');
                document.getElementById('ai-image-preview-container').innerHTML = '';
                aiImageBase64 = null; aiImageMimeType = null;
                document.getElementById('ai-file-input').value = '';
                setTimeout(() => { aiInput.placeholder = originalPlaceholder; }, 2000);
            }
        }
        function handleAIResponse(response) {
            const { intent, details } = response;
            if (details && details.short_reply) {
                showAIReply(details.short_reply);
            }
            
            switch (intent) {
                case 'create_task': createTask(details.text); break;
                case 'delete_task': deleteTask(details.text); break;
                case 'create_note':
                case 'image_query': saveMomentFromAI(details.full_response); break;
                case 'summarize_day': summarizeDay(); break;
                case 'general_query': handleGeneralQuery(details.text); break;
                default:
                    showAIReply("I didn't understand that command.");
            }
        }
        async function createTask(text) {
            await dbAction(TASKS_STORE, 'readwrite', (s, res) => s.add({ text: text, completed: false }).onsuccess = res);
            await renderWidgets();
        }
        async function deleteTask(text) {
            const tasks = await dbAction(TASKS_STORE, 'readonly', (s, res) => s.getAll().onsuccess = e => res(e.target.result));
            const taskToDelete = tasks.find(t => t.text.toLowerCase().includes(text.toLowerCase()));
            if (taskToDelete) {
                await dbAction(TASKS_STORE, 'readwrite', (s, res) => s.delete(taskToDelete.id).onsuccess = res);
                await renderWidgets();
            } else {
                showAIReply(`Task "${text}" not found.`);
            }
        }
        async function saveMomentFromAI(text) {
            const moment = { timestamp: Date.now(), text, tags: ['ai-note'], type: 'text' };
            await dbAction(MOMENTS_STORE, 'readwrite', (s, res) => s.add(moment).onsuccess = res);
            await refreshApp();
        }
        async function summarizeDay() {
            const moments = await dbAction(MOMENTS_STORE, 'readonly', (s, res) => s.getAll().onsuccess = e => res(e.target.result));
            const today = new Date().toLocaleDateString('en-CA');
            const todaysMoments = moments.filter(m => new Date(m.timestamp).toLocaleDateString('en-CA') === today);

            if (todaysMoments.length === 0) {
                showAIReply("No moments today to summarize.");
                saveMomentFromAI("Tried to summarize the day, but no moments were recorded.");
                return;
            }

            const momentsText = todaysMoments.map((m, i) => `Entry ${i+1}: ${m.text || `[${m.type} content]`}`).join('\n');
            const prompt = `Based on these journal entries, provide a one-paragraph summary and a one-sentence short reply. JSON format: {"full_response": "...", "short_reply": "..."}\n\n${momentsText}`;
            
            const payload = { "contents": [{"parts": [{"text": prompt}]}] };
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const rawJson = result.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                const data = JSON.parse(rawJson);

                saveMomentFromAI(`Today's Summary:\n${data.full_response}`);
                showAIReply(data.short_reply);
            } catch (error) {
                console.error("Error summarizing day:", error);
                showAIReply("Couldn't summarize the day.");
            }
        }
        async function handleGeneralQuery(queryText) {
            const systemPrompt = `You are a helpful assistant. Provide a full answer and a very short, one-sentence summary. Format as JSON: {"full_response": "...", "short_reply": "..."}`;
            const payload = { "contents": [{"parts": [{"text": queryText}]}], "systemInstruction": { "parts": [{"text": systemPrompt }] } };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const rawJson = result.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                const data = JSON.parse(rawJson);

                saveMomentFromAI(`Response to "${queryText}":\n\n${data.full_response}`);
                showAIReply(data.short_reply);
            } catch (error) {
                console.error("Error with general query:", error);
                showAIReply("Sorry, I couldn't get an answer.");
            }
        }


        // --- OTHER PAGES ---
        let graphAnimationId;
        async function renderMemoryGraph() {
            if (graphAnimationId) cancelAnimationFrame(graphAnimationId);
            const svg = document.getElementById('memory-graph-svg');
            svg.innerHTML = '';

            const moments = await dbAction(MOMENTS_STORE, 'readonly', (store, resolve) => store.getAll().onsuccess = e => resolve(e.target.result));
            if (moments.length < 2) {
                svg.innerHTML = `<text x="50%" y="50%" fill="var(--text-secondary)" text-anchor="middle">Create more moments with shared tags to build your graph.</text>`;
                return;
            }

            const { width, height } = svg.getBoundingClientRect();
            const nodes = moments.map(m => ({ id: m.id, text: (m.text || 'media').substring(0, 15), tags: m.tags, x: Math.random() * width, y: Math.random() * height, vx: 0, vy: 0 }));
            const links = [];
            const tagMap = new Map();

            nodes.forEach(node => {
                (node.tags || []).forEach(tag => {
                    if (!tagMap.has(tag)) tagMap.set(tag, []);
                    tagMap.get(tag).push(node.id);
                });
            });

            tagMap.forEach(ids => {
                if (ids.length > 1) {
                    for (let i = 0; i < ids.length; i++) {
                        for (let j = i + 1; j < ids.length; j++) {
                            links.push({ source: ids[i], target: ids[j] });
                        }
                    }
                }
            });

            const nodeMap = new Map(nodes.map(n => [n.id, n]));

            const linkElements = document.createElementNS("http://www.w3.org/2000/svg", "g");
            links.forEach(() => {
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute('class', 'graph-link');
                linkElements.appendChild(line);
            });
            svg.appendChild(linkElements);

            const nodeElements = document.createElementNS("http://www.w3.org/2000/svg", "g");
            nodes.forEach(node => {
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.setAttribute('class', 'graph-node');
                g.innerHTML = `<circle r="20"></circle><text y="35">${node.text}</text>`;
                nodeElements.appendChild(g);
                node.element = g;
            });
            svg.appendChild(nodeElements);

            // Drag handling
            let selectedNode = null;
            svg.addEventListener('mousedown', e => {
                const target = e.target.closest('.graph-node');
                if (target) {
                    const node = nodes.find(n => n.element === target);
                    if (node) {
                        selectedNode = nodeMap.get(node.id);
                    }
                }
            });
            svg.addEventListener('mousemove', e => {
                if (selectedNode) {
                    selectedNode.x = e.offsetX;
                    selectedNode.y = e.offsetY;
                }
            });
            svg.addEventListener('mouseup', () => { selectedNode = null; });
            svg.addEventListener('mouseleave', () => { selectedNode = null; });


            function simulation() {
                // Forces
                const repulsion = -500, attraction = 0.05, centering = 0.1;
                nodes.forEach(n1 => {
                    nodes.forEach(n2 => {
                        if (n1 === n2) return;
                        const dx = n2.x - n1.x;
                        const dy = n2.y - n1.y;
                        const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                        const force = repulsion / (dist * dist);
                        n1.vx += force * dx / dist;
                        n1.vy += force * dy / dist;
                    });
                });

                links.forEach(link => {
                    const source = nodeMap.get(link.source);
                    const target = nodeMap.get(link.target);
                    if (!source || !target) return;
                    const dx = target.x - source.x;
                    const dy = target.y - source.y;
                    source.vx += dx * attraction;
                    source.vy += dy * attraction;
                    target.vx -= dx * attraction;
                    target.vy -= dy * attraction;
                });

                nodes.forEach(node => {
                    if(node !== selectedNode) {
                        node.vx += (width / 2 - node.x) * centering;
                        node.vy += (height / 2 - node.y) * centering;
                        node.vx *= 0.9; // Damping
                        node.vy *= 0.9;
                        node.x += node.vx;
                        node.y += node.vy;
                    }
                     // Boundary collision
                    node.x = Math.max(20, Math.min(width - 20, node.x));
                    node.y = Math.max(20, Math.min(height - 20, node.y));
                });

                // Update SVG
                nodes.forEach(node => node.element.setAttribute('transform', `translate(${node.x},${node.y})`));
                links.forEach((link, i) => {
                    const source = nodeMap.get(link.source);
                    const target = nodeMap.get(link.target);
                    if (!source || !target) return;
                    const line = linkElements.children[i];
                    line.setAttribute('x1', source.x);
                    line.setAttribute('y1', source.y);
                    line.setAttribute('x2', target.x);
                    line.setAttribute('y2', target.y);
                });
                graphAnimationId = requestAnimationFrame(simulation);
            }
            simulation();
        }

        async function renderJournal() {
            const container = document.getElementById('journal-container');
            container.innerHTML = `<h2 class="title-font text-3xl font-bold mb-6">Journal</h2>`;

            const moments = await dbAction(MOMENTS_STORE, 'readonly', (store, resolve) => store.getAll().onsuccess = e => resolve(e.target.result.sort((a,b) => b.timestamp - a.timestamp)));
            if (moments.length === 0) {
                 container.innerHTML += `<div class="text-center mt-20 text-[var(--text-secondary)]"><i data-lucide="book-open-check" class="w-16 h-16 mx-auto"></i><p class="mt-4">Your journal is empty.</p></div>`;
                 lucide.createIcons();
                 return;
            }

            const groupedByDay = moments.reduce((acc, m) => {
                const date = new Date(m.timestamp).toLocaleDateString('en-CA'); // YYYY-MM-DD
                if (!acc[date]) acc[date] = [];
                acc[date].push(m);
                return acc;
            }, {});

            for (const dateStr in groupedByDay) {
                const dayMoments = groupedByDay[dateStr];
                const date = new Date(dayMoments[0].timestamp);
                const dayContainer = document.createElement('div');
                
                const heading = document.createElement('h3');
                heading.className = 'title-font text-2xl mb-4 border-b border-[var(--border-color)] pb-2';
                heading.textContent = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                dayContainer.appendChild(heading);

                const entriesContainer = document.createElement('div');
                entriesContainer.className = "space-y-4";
                dayMoments.forEach(m => {
                    let mediaContent = '';
                    if (m.data) {
                        const mediaUrl = URL.createObjectURL(m.data);
                        if (m.type === 'image') mediaContent = `<img src="${mediaUrl}" class="mt-2 rounded-lg max-h-40 w-auto">`;
                        if (m.type === 'video') mediaContent = `<video controls src="${mediaUrl}" class="mt-2 rounded-lg w-full max-w-sm"></video>`;
                        if (m.type === 'audio') mediaContent = `<audio controls src="${mediaUrl}" class="w-full max-w-sm mt-2"></audio>`;
                    }
                    const entry = document.createElement('div');
                    entry.className = 'journal-entry p-4 rounded-lg';
                    entry.innerHTML = `
                        <div class="flex justify-between items-start">
                           <div>
                                <p class="whitespace-pre-wrap">${m.text || ''}</p>
                                ${mediaContent}
                           </div>
                           <span class="text-xs text-[var(--text-secondary)] flex-shrink-0 ml-4">${new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                    `;
                    entriesContainer.appendChild(entry);
                });
                dayContainer.appendChild(entriesContainer);
                container.appendChild(dayContainer);
            }
        }

    </script>
</body>
</html>
