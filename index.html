<!DOCTYPE html> 
 <html lang="en" class="dark"> 
 <head> 
 	 <meta charset="UTF-8"> 
 	 <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"> 
 	 <title>Iris Space</title> 
 	 
 	 <meta name="apple-mobile-web-app-capable" content="yes"> 
 	 <meta name="mobile-web-app-capable" content="yes"> 
 	 <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> 
 	 <meta name="theme-color" content="#0A0A0A"> 
 	 <link rel="manifest" href="manifest.json"> 
 	 <link rel="apple-touch-icon" href="https://placehold.co/192x192/0891b2/ffffff?text=IS"> 

 	 <script src="https://cdn.tailwindcss.com"></script> 
 	 <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script> 
 	 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> 
 	 <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.js"></script> 

 	 <style> 
 		 @import url('https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600&family=Playfair+Display:wght@700&display=swap'); 
 		 
 		 :root { 
 			 --cyan-glow: 0 0 8px rgba(34, 211, 238, 0.6), 0 0 16px rgba(34, 211, 238, 0.4), 0 0 24px rgba(34, 211, 238, 0.2); 
 		 } 

 		 .dark { 
 			 --bg-primary: #0A0A0A; 
 			 --bg-secondary: #101010; 
 			 --surface: #1A1A1A; 
 			 --text-primary: #E0E0E0; 
 			 --text-secondary: #A0A0A0; 
 			 --accent: #22D3EE; 
 			 --accent-light: #A5F3FC; 
 			 --border-color: #2A2A2A; 
 			 --font-body: 'Sora', sans-serif; 
 			 --font-title: 'Playfair Display', serif; 
 		 } 
 		 
 		 body { 
 			 font-family: var(--font-body); 
 			 background-color: var(--bg-primary); 
 			 color: var(--text-primary); 
 			 overscroll-behavior: none; 
 			 transition: background-color 0.5s, color 0.5s; 
 		 } 
 		 
 		 #app-container { 
 			 background: linear-gradient(-45deg, #0A0A0A, #0d1a26, #0A0A0A, #1c2b3a); 
 			 background-size: 400% 400%; 
 			 animation: gradientBG 15s ease infinite; 
 		 } 

 		 @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } } 

 		 .title-font { font-family: var(--font-title); } 

 		 .widget, .modal-pane, .timeline-item, .calendar-day, .day-detail-entry, .chat-bubble { 
 			 backdrop-filter: blur(25px) saturate(150%); 
 			 -webkit-backdrop-filter: blur(25px) saturate(150%); 
 			 background-color: rgba(26, 26, 26, 0.7); 
 			 border: 1px solid var(--border-color); 
 			 transition: all 0.3s ease; 
 		 } 
 		 
 		 .page { animation: fadeIn 0.5s ease-out forwards; } 
 		 .page.hidden { display: none; } 
 		 @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } 

 		 /* Animations */ 
 		 @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } } 
 		 .modal-pane, .chat-bubble { animation: scaleIn 0.4s ease-out forwards; } 

 		 @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } } 
 		 .widget, .timeline-item { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; animation-fill-mode: both; } 

 		 @keyframes iconPress { 0%, 100% { transform: scale(1); } 50% { transform: scale(0.85); } } 
 		 .anim-press { animation: iconPress 0.3s ease-in-out; } 

 		 .sortable-ghost { opacity: 0.4; background: var(--surface); } 

 		 ::-webkit-scrollbar { width: 5px; } 
 		 ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; } 
 		 
 		 #ai-mic-btn.is-recording, #record-audio-btn.is-recording { color: var(--accent); animation: pulse 1.5s infinite ease-in-out; } 
 		 @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } } 

 		 .image-preview-container { position: relative; display: inline-block; } 
 		 .image-preview-container img { max-height: 96px; border-radius: 0.375rem; border: 1px solid var(--border-color); } 
 		 .image-preview-remove-btn { position: absolute; top: -8px; right: -8px; background-color: var(--surface); border-radius: 9999px; padding: 2px; border: 1px solid var(--border-color); cursor: pointer; transition: color 0.2s; } 
 		 .image-preview-remove-btn:hover { color: var(--accent); } 

 		 #ai-input-visualizer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0; transition: opacity 0.5s ease-in-out; } 
 		 #ai-input-visualizer.is-active, #ai-input-container.is-thinking #ai-input-visualizer { opacity: 1; } 

 		 #ai-input-container.is-thinking #ai-input { animation: thinking-border 2s ease-in-out infinite; } 
 		 @keyframes thinking-border { 0%, 100% { border-color: var(--border-color); } 50% { border-color: var(--accent); box-shadow: var(--cyan-glow); } } 

 		 /* Thinking Animation V2 */ 
 		 #ai-input-container #ai-actions > * { transition: opacity 0.3s, transform 0.3s; } 
 		 #ai-input-container.is-thinking #ai-actions > :not(#ai-thinking-icon) { opacity: 0; transform: scale(0.5); pointer-events: none; } 
 		 #ai-input-container:not(.is-thinking) #ai-thinking-icon { opacity: 0; transform: scale(0.5); pointer-events: none; } 
 		 @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } } 
 		 #ai-thinking-icon { animation: spin 1s linear infinite; } 

 		 #ai-input { background-color: #101010; color: var(--text-primary); } 
 		 
 		 @keyframes popupEnter { 
 			 from { opacity: 0; transform: translateX(-50%) translateY(-20px); } 
 			 to { opacity: 1; transform: translateX(-50%) translateY(0); } 
 		 } 
 		 #ai-reply-popup {
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
            pointer-events: none;
            transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
         }
         #ai-reply-popup.is-visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
         }
         #ai-reply-popup.is-flying {
            transition: transform 0.6s cubic-bezier(0.4, -0.3, 1, 1), opacity 0.6s ease-in;
         }

 		 #mindspace-svg { width: 100%; height: 100%; } 
 		 .graph-node { cursor: grab; } .graph-node:active { cursor: grabbing; } 
 		 .graph-node circle { fill: var(--surface); stroke: var(--accent); stroke-width: 2px; transition: all 0.2s ease-in-out; } 
 		 .graph-node text { fill: var(--text-secondary); font-size: 12px; font-family: var(--font-body); text-anchor: middle; pointer-events: none; user-select: none; } 
 		 .graph-node:hover circle { fill: var(--accent); transform: scale(1.1); } 
 		 .graph-link { stroke: var(--border-color); stroke-width: 1.5px; opacity: 0.5; } 
 		 
 		 #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; } 
 		 .calendar-day { min-height: 100px; padding: 8px; border-radius: 8px; cursor: pointer; position: relative; } 
 		 .calendar-day:hover { border-color: var(--accent-light); } 
 		 .calendar-day.is-today { border-color: var(--accent); box-shadow: var(--cyan-glow); } 
 		 .calendar-day-number { font-weight: 600; } 
 		 .calendar-moment-dots { position: absolute; bottom: 8px; left: 8px; display: flex; gap: 4px; } 
 		 .calendar-moment-dot { width: 6px; height: 6px; border-radius: 50%; background-color: var(--accent); } 

 		 /* Improved Timeline & Chat */ 
 		 .timeline-tag { background-color: var(--surface); border: 1px solid var(--border-color); padding: 2px 8px; border-radius: 99px; font-size: 0.75rem; } 
 		 .chat-bubble { max-width: 80%; width: fit-content; padding: 10px 15px; border-radius: 20px; } 
 		 .user-bubble { background-color: var(--accent); color: black; margin-left: auto; border-bottom-right-radius: 5px; } 
 		 .ai-bubble { background-color: var(--surface); border-bottom-left-radius: 5px; } 

 		 /* Widget Config */ 
 		 .widget-config-btn { position: absolute; top: 4px; right: 4px; color: var(--text-secondary); opacity: 0.2; transition: all 0.3s; } 
 		 .widget:hover .widget-config-btn { opacity: 1; color: var(--text-primary); } 
 	 </style> 
 </head> 
 <body class="overflow-hidden"> 

 	 <div id="app-container" class="h-screen w-screen"> 
 	 <div id="app-overlay" class="h-full w-full"> 
 		 <div id="app-wrapper" class="h-full w-full flex flex-col"> 
 			 <header class="w-full p-4 flex justify-between items-center z-20 flex-shrink-0"> 
 				 <h1 class="title-font text-2xl font-bold text-white">Iris Space</h1> 
 				 <div class="flex items-center space-x-2"> 
 					 <button id="chat-history-btn" data-view="chat-view" class="text-[var(--text-secondary)] hover:text-white p-2 rounded-full transition-colors"><i data-lucide="message-square"></i></button> 
 					 <button id="widget-settings-btn" class="text-[var(--text-secondary)] hover:text-white p-2 rounded-full transition-colors"><i data-lucide="layout-template"></i></button> 
 					 <button id="search-btn" class="text-[var(--text-secondary)] hover:text-white p-2 rounded-full transition-colors"><i data-lucide="search"></i></button> 
 				 </div> 
 			 </header> 

 			 <main id="main-content" class="flex-grow p-4 overflow-y-auto relative"> 
 				 <div id="homescreen-view" class="page h-full"><div id="widget-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div></div> 
 				 <div id="timeline-view" class="page hidden"><div id="timeline-container" class="space-y-4"></div></div> 
 				 <div id="mindspace-view" class="page hidden h-full"><svg id="mindspace-svg"></svg></div> 
 				 <div id="calendar-view" class="page hidden"><div id="calendar-container" class="space-y-4"></div></div> 
 				 <div id="chat-view" class="page hidden flex flex-col h-full"><div id="chat-container" class="space-y-4 flex-grow overflow-y-auto"></div></div> 
 			 </main> 
 			 
 			 <div id="ai-input-container" class="w-full p-4 flex-shrink-0 z-10"> 
 				 <div id="ai-image-preview-container" class="w-full max-w-2xl mx-auto flex justify-center mb-2"></div> 
 				 <div class="relative w-full max-w-2xl mx-auto"> 
 					 <canvas id="ai-input-visualizer"></canvas> 
 					 <input type="text" id="ai-input" placeholder="Talk to Space..." class="relative w-full bg-[var(--surface)]/80 backdrop-blur-sm border border-[var(--border-color)] rounded-full py-3 pl-14 pr-28 text-base focus:outline-none focus:border-[var(--accent)] transition-all duration-300"> 
 					 <label for="ai-file-input" class="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] hover:text-[var(--accent)] p-2 rounded-full cursor-pointer z-10"> 
 						 <i data-lucide="paperclip" class="w-6 h-6"></i> 
 					 </label> 
 					 <input type="file" id="ai-file-input" class="hidden" accept="image/*"> 
 					 <div id="ai-actions" class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center z-10 h-full"> 
 						 <button id="ai-mic-btn" class="text-[var(--text-secondary)] hover:text-[var(--accent)] p-2 rounded-full"> 
 							 <i data-lucide="mic" class="w-6 h-6"></i> 
 						 </button> 
 						 <button id="ai-send-btn" class="text-[var(--text-secondary)] hover:text-[var(--accent)] p-2 rounded-full"> 
 							 <i data-lucide="send" class="w-6 h-6"></i> 
 						 </button> 
 						 <div id="ai-thinking-icon" class="text-[var(--accent)] p-2 absolute right-0"><i data-lucide="loader-circle" class="w-6 h-6"></i></div> 
 					 </div> 
 				 </div> 
 			 </div> 

 			 <footer class="w-full p-2 flex justify-around items-center z-20 flex-shrink-0 bg-black/30 backdrop-blur-md border-t border-[var(--border-color)]"> 
 				 <button data-view="homescreen-view" class="nav-btn text-[var(--accent)] p-3 rounded-full"><i data-lucide="layout-grid"></i></button> 
 				 <button data-view="timeline-view" class="nav-btn text-[var(--text-secondary)] p-3 rounded-full"><i data-lucide="list-ordered"></i></button> 
 				 <button data-view="mindspace-view" class="nav-btn text-[var(--text-secondary)] p-3 rounded-full"><i data-lucide="brain-circuit"></i></button> 
 				 <button data-view="calendar-view" class="nav-btn text-[var(--text-secondary)] p-3 rounded-full"><i data-lucide="calendar-days"></i></button> 
 			 </footer> 
 		 </div> 
 		 
 		 <button id="create-moment-btn" class="fixed bottom-[140px] right-5 z-30 p-4 bg-[var(--accent)] text-black rounded-full shadow-[var(--cyan-glow)] hover:bg-cyan-200 transform hover:scale-110 transition-all duration-300"> 
 			 <i data-lucide="plus" class="w-8 h-8"></i> 
 		 </button> 

 		 <div id="modal-backdrop" class="hidden fixed inset-0 bg-black/60 z-40"></div> 
 		 
 		 <div id="ai-reply-popup" class="fixed bottom-36 left-1/2 w-full max-w-sm p-4 z-[100] -translate-x-1/2"> 
 			 <div class="modal-pane p-3"> 
 				 <div class="flex items-center"> 
 					 <div class="bg-cyan-500/20 p-2 rounded-full"><i data-lucide="sparkles" class="w-6 h-6 text-[var(--accent)]"></i></div> 
 					 <div class="ml-3"><p id="ai-reply-text" class="text-sm font-medium text-[var(--text-primary)]"></p></div> 
 				 </div> 
 			 </div> 
 		 </div> 

 		 <!-- MODALS --> 
 		 <div id="search-modal" class="hidden fixed inset-0 flex flex-col items-center justify-center z-50 p-4"></div> 
 		 <div id="create-moment-modal" class="hidden fixed inset-0 flex flex-col items-center justify-center z-50 p-4"></div> 
 		 <div id="widget-settings-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 p-4"></div> 
 		 <div id="day-detail-modal" class="hidden fixed inset-0 flex flex-col items-center justify-center z-50 p-4"></div> 
 		 <div id="widget-config-modal" class="hidden fixed inset-0 flex flex-col items-center justify-center z-50 p-4"></div> 
 	 </div> 
 	 </div> 

 	 <script type="module"> 
 		 // --- INITIALIZATION --- 
 		 const { jsPDF } = window.jspdf; 
 		 const DB_NAME = 'IrisSpaceDB', DB_VERSION = 8; 
 		 const MOMENTS_STORE = 'moments', WIDGET_STORE = 'widgets', SETTINGS_STORE = 'settings', TASKS_STORE = 'tasks', CHAT_HISTORY_STORE = 'chatHistory', QUICK_NOTES_STORE = 'quickNotes'; 
 		 const GEMINI_API_KEY = "AIzaSyAnmS4y8qRL-bquwc6FZbZ6OZFqrADgwx0";
 		 let db, aiImageBase64 = null, aiImageMimeType = null, currentCalendarDate = new Date(); 
 		 
 		 window.onload = async () => { 
 			 lucide.createIcons(); 
 			 setupAIVisualizer(); 
 			 try { 
 				 db = await openDB(); 
 				 renderAllModals(); 
 				 setupEventListeners(); 
 				 setupSpeechRecognition(); 
 				 await refreshApp(); 
 				 showView('homescreen-view'); 
                 setInterval(checkNotifications, 3600000); 
 			 } catch (error) { console.error('Failed to initialize app:', error); } 
 		 }; 

 		 // --- HAPTICS --- 
 		 function hapticFeedback(style = 'light') { if ('vibrate' in navigator) navigator.vibrate({ light: [50], medium: [100], heavy: [150] }[style] || [50]); } 

 		 // --- DATABASE --- 
 		 function openDB() { 
 			 return new Promise((resolve, reject) => { 
 				 const request = indexedDB.open(DB_NAME, DB_VERSION); 
 				 request.onerror = () => reject('DB Error'); 
 				 request.onsuccess = (e) => resolve(e.target.result); 
 				 request.onupgradeneeded = (e) => { 
 					 let db = e.target.result; 
 					 if (!db.objectStoreNames.contains(MOMENTS_STORE)) db.createObjectStore(MOMENTS_STORE, { keyPath: 'id', autoIncrement: true }); 
 					 if (!db.objectStoreNames.contains(WIDGET_STORE)) db.createObjectStore(WIDGET_STORE, { keyPath: 'id' }); 
 					 if (!db.objectStoreNames.contains(SETTINGS_STORE)) db.createObjectStore(SETTINGS_STORE, { keyPath: 'key' }); 
 					 if (!db.objectStoreNames.contains(TASKS_STORE)) {
                        const taskStore = db.createObjectStore(TASKS_STORE, { keyPath: 'id', autoIncrement: true });
                        taskStore.createIndex('createdAt', 'createdAt', { unique: false });
                     }
 					 if (!db.objectStoreNames.contains(CHAT_HISTORY_STORE)) db.createObjectStore(CHAT_HISTORY_STORE, { keyPath: 'id', autoIncrement: true }); 
                     if (!db.objectStoreNames.contains(QUICK_NOTES_STORE)) db.createObjectStore(QUICK_NOTES_STORE, { keyPath: 'id' });
 				 }; 
 			 }); 
 		 } 
 		 const dbAction = (storeName, mode, action) => new Promise((resolve, reject) => { 
 			  const tx = db.transaction(storeName, mode); 
 			  const store = tx.objectStore(storeName); 
 			  const request = action(store); 
 			  request.onsuccess = (e) => resolve(e.target.result); 
 			  request.onerror = (e) => reject(e.target.error); 
 		 }); 

 		 // --- CORE & UI --- 
 		 async function refreshApp() { 
 			 await Promise.all([renderWidgets(), renderTimeline(), renderMindspaceGraph(), renderCalendar(currentCalendarDate), renderChatHistory()]); 
 		 } 
 		 function showView(viewId) { 
 			 document.querySelectorAll('.page').forEach(p => p.classList.add('hidden')); 
 			 document.getElementById(viewId)?.classList.remove('hidden'); 
 			 document.querySelectorAll('.nav-btn, #chat-history-btn').forEach(btn => { 
 				 const isChatBtn = btn.id === 'chat-history-btn' && viewId === 'chat-view'; 
 				 const isNavBtn = btn.classList.contains('nav-btn') && btn.dataset.view === viewId; 
 				 btn.classList.toggle('text-[var(--accent)]', isChatBtn || isNavBtn); 
 				 btn.classList.toggle('text-[var(--text-secondary)]', !isChatBtn && !isNavBtn); 
 			 }); 
 			 if (viewId === 'mindspace-view') renderMindspaceGraph(); 
 			 if (viewId === 'calendar-view') renderCalendar(currentCalendarDate); 
 		 } 
 		 function animateIcon(element) { if (!element) return; hapticFeedback('light'); element.classList.add('anim-press'); element.addEventListener('animationend', () => element.classList.remove('anim-press'), { once: true }); } 
 		 function showModal(id) { document.getElementById('modal-backdrop').classList.remove('hidden'); document.getElementById(id).classList.remove('hidden'); } 
 		 function closeModal(id) { document.getElementById('modal-backdrop').classList.add('hidden'); document.getElementById(id).classList.add('hidden'); } 
 		 
        let replyTimeout;
        function showAIReply(shortText, animateToChat = false) {
            const popup = document.getElementById('ai-reply-popup');
            const textEl = document.getElementById('ai-reply-text');
            
            clearTimeout(replyTimeout);

            popup.classList.remove('is-flying');
            popup.style.transform = '';
            popup.style.opacity = '';
            
            let displayText = shortText;
            if(displayText && displayText.length > 100) {
                displayText = displayText.substring(0, 97) + '...';
            }
            textEl.textContent = displayText;
            
            void popup.offsetWidth;

            popup.classList.add('is-visible');

            replyTimeout = setTimeout(() => {
                if (animateToChat) {
                    const chatBtn = document.getElementById('chat-history-btn');
                    if (!chatBtn) { popup.classList.remove('is-visible'); return; }

                    const popupRect = popup.getBoundingClientRect();
                    const btnRect = chatBtn.getBoundingClientRect();

                    const translateX = btnRect.left + (btnRect.width / 2) - (popupRect.left + (popupRect.width / 2));
                    const translateY = btnRect.top + (btnRect.height / 2) - (popupRect.top + (popupRect.height / 2));
                    
                    popup.classList.add('is-flying');
                    popup.style.transform = `translateX(calc(-50% + ${translateX}px)) translateY(${translateY}px) scale(0.1)`;
                    popup.style.opacity = '0';

                    animateIcon(chatBtn.querySelector('i'));

                    popup.addEventListener('transitionend', () => {
                        popup.classList.remove('is-visible', 'is-flying');
                        popup.style.transform = '';
                        popup.style.opacity = '';
                    }, { once: true });

                } else {
                    popup.classList.remove('is-visible');
                }
            }, 4000);
        }

 		 // --- MODAL RENDERING --- 
 		 function renderAllModals() { 
 			 document.getElementById('search-modal').innerHTML = `<div class="modal-pane w-full max-w-2xl max-h-[80vh] rounded-lg flex flex-col"><div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center"><h2 class="title-font text-xl">Search</h2><button id="close-search-modal" class="p-1"><i data-lucide="x"></i></button></div><div class="p-4 border-b border-[var(--border-color)]"><div class="relative"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-[var(--text-secondary)]"></i><input type="text" id="search-input" placeholder="Search..." class="w-full bg-transparent pl-10 pr-4 py-2 rounded-lg focus:outline-none"></div></div><div id="search-results" class="flex-grow overflow-y-auto p-4 space-y-3"></div></div>`; 
 			 document.getElementById('create-moment-modal').innerHTML = `<div class="modal-pane w-full max-w-md rounded-lg flex flex-col"><div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center"><h2 class="title-font text-xl">Create Moment</h2><button id="close-create-moment-modal" class="p-1"><i data-lucide="x"></i></button></div><div class="p-4 space-y-4"><div id="moment-image-preview-container" class="w-full flex justify-center mb-2"></div><div id="moment-audio-preview-container" class="w-full flex justify-center mb-2"></div><textarea id="moment-text-input" placeholder="What's on your mind?" class="w-full h-24 bg-transparent p-2 rounded border border-[var(--border-color)] focus:outline-none focus:border-[var(--accent)]"></textarea><input type="text" id="moment-tags-input" placeholder="Tags (comma separated)" class="w-full bg-transparent p-2 rounded border border-[var(--border-color)] focus:outline-none focus:border-[var(--accent)]"><div class="flex justify-between items-center"><label for="moment-file-input" class="cursor-pointer p-2 rounded border border-[var(--border-color)] hover:border-[var(--accent)]"><i data-lucide="paperclip" class="inline"></i> Attach</label><input type="file" id="moment-file-input" class="hidden" accept="image/*,video/*"><button id="record-audio-btn" class="p-2 rounded border border-[var(--border-color)] hover:border-[var(--accent)] transition-all"><i data-lucide="mic" class="inline"></i> Record</button></div></div><div class="p-4 border-t border-[var(--border-color)] text-right"><button id="save-moment-btn" class="px-4 py-2 bg-[var(--accent)] text-black rounded font-semibold hover:opacity-80 transition">Save</button></div></div>`; 
 			 document.getElementById('widget-settings-modal').innerHTML = `<div class="modal-pane w-full max-w-2xl rounded-lg flex flex-col max-h-[80vh]"><div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center"><h2 class="title-font text-xl">Manage Widgets</h2><button id="close-widget-settings-modal" class="p-1"><i data-lucide="x"></i></button></div><div class="flex-grow overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 gap-4"><div><h3 class="font-semibold mb-2">Active Widgets</h3><div id="active-widgets-list" class="min-h-[200px] bg-[var(--bg-secondary)] p-2 rounded-md space-y-2"></div></div><div><h3 class="font-semibold mb-2">Available Widgets</h3><div id="available-widgets-list" class="min-h-[200px] bg-[var(--bg-secondary)] p-2 rounded-md space-y-2"></div></div></div><div class="p-4 border-t border-[var(--border-color)] text-right"><button id="save-widgets-btn" class="px-4 py-2 bg-[var(--accent)] text-black rounded font-semibold hover:opacity-80 transition">Save & Close</button></div></div>`; 
 			 document.getElementById('day-detail-modal').innerHTML = `<div class="modal-pane w-full max-w-2xl max-h-[80vh] rounded-lg flex flex-col"><div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center"><h2 id="day-detail-title" class="title-font text-xl"></h2><button id="close-day-detail-modal" class="p-1"><i data-lucide="x"></i></button></div><div id="day-detail-content" class="flex-grow overflow-y-auto p-4 space-y-3"></div></div>`; 
 			 document.getElementById('widget-config-modal').innerHTML = `<div class="modal-pane w-full max-w-md rounded-lg flex flex-col"><div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center"><h2 id="widget-config-title" class="title-font text-xl"></h2><button id="close-widget-config-modal" class="p-1"><i data-lucide="x"></i></button></div><div id="widget-config-content" class="p-4 space-y-4"></div><div class="p-4 border-t border-[var(--border-color)] text-right"><button id="save-widget-config-btn" class="px-4 py-2 bg-[var(--accent)] text-black rounded font-semibold hover:opacity-80 transition">Save</button></div></div>`; 
 			 lucide.createIcons(); 
 		 } 
 		 
 		 // --- EVENT LISTENERS --- 
 		 function setupEventListeners() { 
 			 document.body.addEventListener('click', async e => { 
 				 const navBtn = e.target.closest('.nav-btn, #chat-history-btn'); 
 				 if (navBtn) { showView(navBtn.dataset.view); animateIcon(navBtn.querySelector('i')); } 

 				 const deleteBtn = e.target.closest('.delete-moment-btn');  
 				 if (deleteBtn) deleteMoment(parseInt(deleteBtn.dataset.momentId, 10)); 

 				 const taskCheckbox = e.target.closest('.task-checkbox');  
 				 if(taskCheckbox) toggleTaskCompletion(parseInt(taskCheckbox.dataset.taskId), taskCheckbox.checked); 

 				 const widgetConfigBtn = e.target.closest('.widget-config-btn');  
 				 if(widgetConfigBtn) openWidgetConfigModal(widgetConfigBtn.dataset.widgetId); 

 				 if (e.target.id === 'enable-notifications-btn') { 
 					 const permission = await Notification.requestPermission(); 
 					 if (permission === 'granted') { 
 						 new Notification('Iris Space', { body: 'Notifications have been enabled!' }); 
 					 } 
 					 await renderWidgets();  
 				 } 
 			 });

            document.body.addEventListener('blur', async e => {
                if (e.target && e.target.id === 'quick-note-textarea') {
                    await dbAction(QUICK_NOTES_STORE, 'readwrite', store => store.put({ id: 'main', content: e.target.value }));
                    hapticFeedback('light');
                }
            }, true);

 			 document.getElementById('search-btn').addEventListener('click', () => { showModal('search-modal'); hapticFeedback('light'); }); 
 			 document.getElementById('create-moment-btn').addEventListener('click', () => { showModal('create-moment-modal'); hapticFeedback('medium'); }); 
 			 document.getElementById('widget-settings-btn').addEventListener('click', () => { showModal('widget-settings-modal'); populateWidgetModal(); hapticFeedback('light'); }); 
 			 document.getElementById('modal-backdrop').addEventListener('click', () => { ['search-modal', 'create-moment-modal', 'widget-settings-modal', 'day-detail-modal', 'widget-config-modal'].forEach(closeModal); }); 
 			 
 			 document.getElementById('close-search-modal').addEventListener('click', () => closeModal('search-modal')); 
 			 document.getElementById('close-create-moment-modal').addEventListener('click', () => closeModal('create-moment-modal')); 
 			 document.getElementById('close-day-detail-modal').addEventListener('click', () => closeModal('day-detail-modal')); 
 			 document.getElementById('close-widget-settings-modal').addEventListener('click', () => closeModal('widget-settings-modal')); 
 			 document.getElementById('close-widget-config-modal').addEventListener('click', () => closeModal('widget-config-modal')); 

 			 document.getElementById('save-moment-btn').addEventListener('click', saveMoment); 
 			 document.getElementById('moment-file-input').addEventListener('change', handleMomentFileSelect); 
 			 document.getElementById('record-audio-btn').addEventListener('click', toggleAudioRecording); 
 			 document.getElementById('save-widgets-btn').addEventListener('click', saveWidgetLayout); 
 			 document.getElementById('ai-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') processCommand(e.target.value); }); 
 			 document.getElementById('ai-send-btn').addEventListener('click', () => { processCommand(document.getElementById('ai-input').value); animateIcon(document.querySelector('#ai-send-btn i')); }); 
 			 document.getElementById('ai-file-input').addEventListener('change', handleAIFileSelect); 
 		 } 

 		 // --- MOMENTS, MEDIA, CHAT --- 
 		 let mediaRecorder, audioChunks = [], audioBlob = null, momentImageBlob = null; 
 		 async function toggleAudioRecording() {
            const recordBtn = document.getElementById('record-audio-btn');
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                recordBtn.classList.remove('is-recording');
                recordBtn.innerHTML = '<i data-lucide="mic" class="inline"></i> Record';
                lucide.createIcons();
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        document.getElementById('moment-audio-preview-container').innerHTML = `<audio controls src="${audioUrl}" class="w-full"></audio>`;
                        stream.getTracks().forEach(track => track.stop()); // Release the mic
                    };
                    mediaRecorder.start();
                    recordBtn.classList.add('is-recording');
                    recordBtn.innerHTML = '<i data-lucide="stop-circle" class="inline"></i> Stop';
                    lucide.createIcons();
                } catch (err) {
                    console.error("Error accessing microphone:", err);
                    showAIReply("Could not access the microphone.");
                }
            }
        } 
 		 async function saveMoment(fromAI = false, aiText = '') { 
            const textInput = document.getElementById('moment-text-input');
            const text = fromAI ? aiText : textInput.value;
            const tagsInput = document.getElementById('moment-tags-input');
            const tags = tagsInput.value.split(',').map(t => t.trim()).filter(Boolean);
            
            if (!text && !momentImageBlob && !audioBlob) return;

            const moment = { text, tags, timestamp: Date.now() };

            if (momentImageBlob) {
                moment.data = momentImageBlob;
                moment.type = 'image';
            } else if (audioBlob) {
                moment.data = audioBlob;
                moment.type = 'audio';
            }

            await dbAction(MOMENTS_STORE, 'readwrite', store => store.add(moment));
            
            if (!fromAI) {
                textInput.value = '';
                tagsInput.value = '';
                momentImageBlob = null;
                audioBlob = null;
                document.getElementById('moment-image-preview-container').innerHTML = '';
                document.getElementById('moment-audio-preview-container').innerHTML = '';
                closeModal('create-moment-modal');
            }
            
            await refreshApp();
        } 
 		 async function renderTimeline() { 
 			 const container = document.getElementById('timeline-container'); 
 			 container.innerHTML = `<h2 class="title-font text-3xl font-bold mb-6">Timeline</h2>`; 
 			 const moments = await dbAction(MOMENTS_STORE, 'readonly', store => store.getAll()); 
 			 moments.sort((a,b) => b.timestamp - a.timestamp); 
 			 if(moments.length === 0) { container.innerHTML += `<div class="text-center mt-20 text-[var(--text-secondary)]"><i data-lucide="moon-star" class="w-16 h-16 mx-auto"></i><p class="mt-4">Your space is clear. Create a moment.</p></div>`; lucide.createIcons(); return; } 
 			 
 			 moments.forEach((m, index) => { 
 				 let mediaContent = '', icon = 'pen-square'; 
 				 if (m.data) { 
 					 const mediaUrl = URL.createObjectURL(m.data); 
 					 if (m.type === 'image') { mediaContent = `<img src="${mediaUrl}" class="mt-2 rounded-lg max-h-60 w-auto">`; icon = 'image'; } 
 					 if (m.type === 'video') { mediaContent = `<video controls src="${mediaUrl}" class="mt-2 rounded-lg w-full"></video>`; icon = 'video'; } 
 					 if (m.type === 'audio') { mediaContent = `<audio controls src="${mediaUrl}" class="w-full mt-2"></audio>`; icon = 'mic'; } 
 				 } 
 				 const tagsHTML = m.tags && m.tags.length ? `<div class="flex flex-wrap gap-2 mt-3">${m.tags.map(t => `<span class="timeline-tag">${t}</span>`).join('')}</div>` : ''; 
 				 const item = document.createElement('div'); 
 				 item.className = 'timeline-item p-4 rounded-lg relative'; 
 				 item.style.animationDelay = `${index * 50}ms`; 
 				 item.innerHTML = ` 
 					 <button class="delete-moment-btn absolute top-2 right-2 p-1 text-[var(--text-secondary)] hover:text-red-500 transition-colors" data-moment-id="${m.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button> 
 					 <p class="whitespace-pre-wrap pr-8">${m.text || ''}</p>  
 					 ${mediaContent} ${tagsHTML} 
 					 <div class="text-xs text-[var(--text-secondary)] mt-3 pt-2 border-t border-[var(--border-color)] flex justify-between items-center"> 
 						 <span><i data-lucide="${icon}" class="inline-block w-3 h-3 mr-1"></i>${new Date(m.timestamp).toLocaleString()}</span> 
 					 </div>`; 
 				 container.appendChild(item); 
 			 }); 
 			 lucide.createIcons(); 
 		 } 
 		 async function deleteMoment(momentId) { await dbAction(MOMENTS_STORE, 'readwrite', store => store.delete(momentId)); await refreshApp(); } 
 		 function handleMomentFileSelect(event) { 
             const file = event.target.files[0];
             if (!file) return;
             momentImageBlob = file;
             audioBlob = null; // Clear audio if file is selected
             document.getElementById('moment-audio-preview-container').innerHTML = '';
             const reader = new FileReader();
             reader.onload = (e) => {
                 document.getElementById('moment-image-preview-container').innerHTML = `<img src="${e.target.result}" class="max-h-24 rounded border border-[var(--border-color)]">`;
             };
             reader.readAsDataURL(file);
         } 
 		 async function saveToChatHistory(userQuery, aiResponse) { 
 			 const entry = { timestamp: Date.now(), userQuery, aiResponse }; 
 			 await dbAction(CHAT_HISTORY_STORE, 'readwrite', store => store.add(entry)); 
 			 await renderChatHistory(); 
 		 } 
 		 async function renderChatHistory() { 
 			 const container = document.getElementById('chat-container'); 
 			 container.innerHTML = ''; 
 			 const history = await dbAction(CHAT_HISTORY_STORE, 'readonly', store => store.getAll()); 
 			 if(history.length === 0) { container.innerHTML = `<div class="text-center mt-20 text-[var(--text-secondary)]"><i data-lucide="bot" class="w-16 h-16 mx-auto"></i><p class="mt-4">Your chat history is empty. <br/> Ask Iris anything!</p></div>`; lucide.createIcons(); return; } 
 			 history.forEach(entry => { 
 				 container.innerHTML += ` 
 					 <div class="chat-bubble user-bubble"><p>${entry.userQuery}</p></div> 
 					 <div class="chat-bubble ai-bubble"><p>${entry.aiResponse}</p></div>`; 
 			 }); 
 			 container.scrollTop = container.scrollHeight; 
 		 } 

 		 // --- WIDGETS --- 
 		 const ALL_WIDGETS = { 
 			 irisBrief: { name: "Iris Brief", render: async () => { 
 				 const tasks = await dbAction(TASKS_STORE, 'readonly', store => store.getAll()); 
 				 const todaysTasks = tasks.filter(t => !t.completed); 
 				 const countdown = await dbAction(SETTINGS_STORE, 'readonly', store => store.get('countdown')); 
 				 let countdownText = ''; 
 				 if (countdown && countdown.date) { 
 					 const targetDate = new Date(countdown.date); 
 					 const diff = targetDate - new Date(); 
                     if (diff > 0) {
                        const daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24)); 
                        countdownText = `<div class="text-xs"><i data-lucide="calendar-clock" class="inline w-3 h-3 mr-1"></i><strong>${daysLeft}</strong> days until ${countdown.event}</div>`; 
                     }
 				 } 
 				 const taskText = `<div class="text-xs"><i data-lucide="check-circle" class="inline w-3 h-3 mr-1"></i>You have <strong>${todaysTasks.length}</strong> pending task${todaysTasks.length !== 1 ? 's' : ''}.</div>`; 
 				 return ` 
 					 <div class="text-left w-full space-y-2"> 
 						 <h3 class="font-bold text-base">Your Briefing</h3> 
 						 ${taskText} 
 						 ${countdownText} 
 						 <div class="text-xs pt-1 border-t border-[var(--border-color)]/50"><i data-lucide="sparkles" class="inline w-3 h-3 mr-1"></i>Have a productive day!</div> 
 					 </div> 
 				 `; 
 			 }}, 
 			 notifications: { name: "Notifications", render: () => { 
 				 if (!('Notification' in window)) return `<p class="text-xs text-red-400">Notifications not supported.</p>`; 
 				 const permission = Notification.permission; 
 				 if (permission === 'granted') return `<div class="flex items-center justify-center gap-2"><i data-lucide="bell-ring" class="text-green-400"></i><p>Notifications ON</p></div>`; 
 				 if (permission === 'denied') return `<div class="flex items-center justify-center gap-2"><i data-lucide="bell-off" class="text-red-400"></i><p>Notifications Blocked</p></div>`; 
 				 return `<button id="enable-notifications-btn" class="w-full px-3 py-2 bg-transparent border border-[var(--accent)] text-[var(--accent)] rounded font-semibold text-sm">Enable Notifications</button>`; 
 			 }}, 
 			 clock: { name: "Clock", render: () => `<div class="text-4xl font-bold">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>` }, 
 			 tasks: { name: "Tasks", render: async () => {
                const tasks = await dbAction(TASKS_STORE, 'readonly', store => store.getAll());
                const pendingTasks = tasks.filter(t => !t.completed);
                if (pendingTasks.length === 0) return `<div><i data-lucide="check-check" class="mx-auto w-8 h-8 text-green-400"></i><p class="text-sm mt-2">All tasks complete!</p></div>`;
                return `<div class="text-left w-full space-y-2 text-sm">
                        <h3 class="font-bold text-base mb-2">Tasks</h3>
                        ${pendingTasks.slice(0, 3).map(t => `
                            <div class="flex items-center gap-2">
                                <input type="checkbox" data-task-id="${t.id}" class="task-checkbox accent-[var(--accent)]">
                                <label>${t.text}</label>
                            </div>
                        `).join('')}
                        ${pendingTasks.length > 3 ? `<p class="text-xs text-[var(--text-secondary)] mt-1">+${pendingTasks.length - 3} more</p>`: ''}
                    </div>`;
             }}, 
             media: { name: "Recent Media", size: 'col-span-2', render: async () => {
                const moments = await dbAction(MOMENTS_STORE, 'readonly', store => store.getAll());
                const imageMoments = moments.filter(m => m.type === 'image').sort((a,b) => b.timestamp - a.timestamp);
                const audioMoments = moments.filter(m => m.type === 'audio').sort((a,b) => b.timestamp - a.timestamp);
                let imageHtml = '<div class="flex-1 flex items-center justify-center bg-black/20 rounded-lg"><i data-lucide="image-off" class="w-8 h-8 text-[var(--text-secondary)]"></i></div>';
                let audioHtml = '<div class="flex-1 flex items-center justify-center bg-black/20 rounded-lg"><i data-lucide="mic-off" class="w-8 h-8 text-[var(--text-secondary)]"></i></div>';
                if (imageMoments.length > 0) {
                    const imageUrl = URL.createObjectURL(imageMoments[0].data);
                    imageHtml = `<div class="flex-1"><img src="${imageUrl}" class="w-full h-full object-cover rounded-lg"></div>`;
                }
                if (audioMoments.length > 0) {
                    const audioUrl = URL.createObjectURL(audioMoments[0].data);
                    audioHtml = `<div class="flex-1 p-2 flex flex-col justify-center items-center"><p class="text-xs text-[var(--text-secondary)] mb-2">Latest Audio</p><audio controls src="${audioUrl}" class="w-full h-8"></audio></div>`;
                }
                return `<div class="w-full h-full flex flex-col md:flex-row gap-2">
                    ${imageHtml}
                    ${audioHtml}
                </div>`;
             }},
 			 countdown: { name: "Countdown", configurable: true, render: async () => {
                const countdown = await dbAction(SETTINGS_STORE, 'readonly', store => store.get('countdown'));
                if (!countdown || !countdown.date) return `<div class="text-sm text-[var(--text-secondary)]">Set a countdown</div>`;
                const targetDate = new Date(countdown.date);
                const diff = targetDate - new Date();
                if (diff <= 0) return `<div class="text-lg font-bold">${countdown.event} has arrived!</div>`;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                return `<div class="text-center">
                    <div class="text-3xl font-bold">${days}d ${hours}h</div>
                    <div class="text-sm">${countdown.event}</div>
                </div>`
             }}, 
             quickNote: { name: "Quick Note", render: async () => {
                const note = await dbAction(QUICK_NOTES_STORE, 'readonly', store => store.get('main'));
                return `<textarea id="quick-note-textarea" class="w-full h-full bg-transparent text-[var(--text-primary)] text-sm p-1 focus:outline-none resize-none">${note?.content || ''}</textarea>`;
             }},
             systemInfo: { name: "System Info", render: async() => {
                const moments = await dbAction(MOMENTS_STORE, 'readonly', store => store.getAll());
                const tasks = await dbAction(TASKS_STORE, 'readonly', store => store.getAll());
                const pendingTasks = tasks.filter(t => !t.completed).length;
                return `<div class="text-left w-full text-xs space-y-1">
                    <h3 class="font-bold text-sm mb-2">System</h3>
                    <div class="flex justify-between"><span>Moments:</span> <span>${moments.length}</span></div>
                    <div class="flex justify-between"><span>Pending Tasks:</span> <span>${pendingTasks}</span></div>
                </div>`;
             }}
 		 }; 
 		 async function renderWidgets() { 
 			 const grid = document.getElementById('widget-grid'); 
 			 grid.innerHTML = ''; 
 			 const widgetLayout = await dbAction(WIDGET_STORE, 'readonly', store => store.get('layout')); 
 			 let userWidgets = widgetLayout?.value || ['irisBrief', 'clock', 'tasks', 'media']; 
 			 
 			 const renderPromises = userWidgets.map(async (widgetId, index) => { 
 				 const widgetDef = ALL_WIDGETS[widgetId]; 
 				 if (!widgetDef) return null; 
 				 const widgetEl = document.createElement('div'); 
 				 widgetEl.className = `widget p-4 rounded-lg min-h-[120px] flex items-center justify-center text-center relative ${widgetDef.size || 'col-span-1'}`; 
 				 if (widgetId === 'media') widgetEl.className += ' p-2'; 
 				 widgetEl.dataset.widgetId = widgetId; 
 				 widgetEl.style.animationDelay = `${index * 50}ms`; 
 				 
 				 const content = await widgetDef.render(); 
 				 let configBtn = widgetDef.configurable ? `<button data-widget-id="${widgetId}" class="widget-config-btn p-1 rounded-full hover:bg-white/10"><i data-lucide="settings-2" class="w-4 h-4"></i></button>` : ''; 
 				 widgetEl.innerHTML = `<div class="w-full h-full">${content || ''}</div>${configBtn}`; 
 				 return widgetEl; 
 			 }); 
 			 const renderedWidgets = await Promise.all(renderPromises); 
 			 renderedWidgets.forEach(el => { if(el) grid.appendChild(el); }); 

 			 lucide.createIcons(); 
 			 if (grid.children.length > 0) Sortable.create(grid, { animation: 150, ghostClass: 'sortable-ghost', onEnd: saveWidgetOrder }); 
 		 } 
 		 async function toggleTaskCompletion(taskId, isCompleted) {
            const task = await dbAction(TASKS_STORE, 'readonly', store => store.get(taskId));
            if (task) {
                const updatedTask = { ...task, completed: isCompleted };
                await dbAction(TASKS_STORE, 'readwrite', store => store.put(updatedTask));
                await renderWidgets();
            }
         } 
 		 async function populateWidgetModal() { 
 			 const activeList = document.getElementById('active-widgets-list'); 
 			 const availableList = document.getElementById('available-widgets-list'); 
 			 activeList.innerHTML = '';  
 			 availableList.innerHTML = ''; 
 			 const widgetLayout = await dbAction(WIDGET_STORE, 'readonly', store => store.get('layout')); 
 			 const userWidgets = widgetLayout?.value || ['irisBrief', 'clock', 'tasks', 'media']; 
 			 Object.keys(ALL_WIDGETS).forEach(id => { 
 				 const item = document.createElement('div'); 
 				 item.className = 'p-2 bg-[var(--surface)] rounded cursor-move'; 
 				 item.textContent = ALL_WIDGETS[id].name; 
 				 item.dataset.widgetId = id; 
 				 if (userWidgets.includes(id)) activeList.appendChild(item); 
 				 else availableList.appendChild(item); 
 			 }); 
 			 Sortable.create(activeList, { group: 'widgets', animation: 150, ghostClass: 'sortable-ghost' }); 
 			 Sortable.create(availableList, { group: 'widgets', animation: 150, ghostClass: 'sortable-ghost' }); 
 		 } 
 		 async function saveWidgetLayout() { 
            const activeList = document.getElementById('active-widgets-list');
            const activeWidgetIds = [...activeList.children].map(item => item.dataset.widgetId);
            await dbAction(WIDGET_STORE, 'readwrite', store => store.put({ id: 'layout', value: activeWidgetIds }));
            closeModal('widget-settings-modal');
            await renderWidgets();
            hapticFeedback('medium');
         } 
 		 async function saveWidgetOrder(evt) { 
            const grid = document.getElementById('widget-grid');
            const newOrder = [...grid.children].map(widget => widget.dataset.widgetId);
            await dbAction(WIDGET_STORE, 'readwrite', store => store.put({ id: 'layout', value: newOrder }));
            await renderWidgets(); 
         } 
 		 async function openWidgetConfigModal(widgetId) {
            const titleEl = document.getElementById('widget-config-title');
            const contentEl = document.getElementById('widget-config-content');
            const saveBtn = document.getElementById('save-widget-config-btn');
            contentEl.innerHTML = ''; 

            titleEl.textContent = `Configure ${ALL_WIDGETS[widgetId].name}`;

            switch (widgetId) {
                case 'countdown':
                    const currentCountdown = await dbAction(SETTINGS_STORE, 'readonly', store => store.get('countdown')) || {};
                    contentEl.innerHTML = `
                        <div>
                            <label for="countdown-event" class="block text-sm font-medium text-[var(--text-secondary)]">Event Name</label>
                            <input type="text" id="countdown-event" value="${currentCountdown.event || ''}" class="mt-1 w-full bg-transparent p-2 rounded border border-[var(--border-color)] focus:outline-none focus:border-[var(--accent)]">
                        </div>
                        <div>
                            <label for="countdown-date" class="block text-sm font-medium text-[var(--text-secondary)]">Target Date</label>
                            <input type="date" id="countdown-date" value="${currentCountdown.date || ''}" class="mt-1 w-full bg-transparent p-2 rounded border border-[var(--border-color)] focus:outline-none focus:border-[var(--accent)]" style="color-scheme: dark;">
                        </div>
                    `;
                    saveBtn.onclick = async () => {
                        const event = document.getElementById('countdown-event').value;
                        const date = document.getElementById('countdown-date').value;
                        await dbAction(SETTINGS_STORE, 'readwrite', store => store.put({ key: 'countdown', event, date }));
                        closeModal('widget-config-modal');
                        await refreshApp();
                    };
                    break;
                default:
                    contentEl.innerHTML = `<p>This widget has no settings.</p>`;
                    saveBtn.onclick = () => closeModal('widget-config-modal');
                    break;
            }
            showModal('widget-config-modal');
        } 

 		 // --- AI ASSISTANT --- 
 		 let recognition, audioContext, analyser, micStream; 
 		 function setupSpeechRecognition() { /* ... implementation ... */ } 
 		 function setupAIVisualizer() { /* ... implementation ... */ } 
 		 function handleAIFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onloadend = () => {
                aiImageBase64 = reader.result.split(',')[1];
                aiImageMimeType = file.type;
                
                const previewContainer = document.getElementById('ai-image-preview-container');
                previewContainer.innerHTML = `<div class="image-preview-container">
                    <img src="${reader.result}" />
                    <button class="image-preview-remove-btn"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>`;
                lucide.createIcons();
                
                previewContainer.querySelector('.image-preview-remove-btn').addEventListener('click', () => {
                    aiImageBase64 = null;
                    aiImageMimeType = null;
                    previewContainer.innerHTML = '';
                    document.getElementById('ai-file-input').value = '';
                });
            };
            reader.readAsDataURL(file);
        }
 		 async function processCommand(commandText) {  
 			 const aiInputContainer = document.getElementById('ai-input-container'); 
 			 const aiInput = document.getElementById('ai-input'); 
 			 if (!commandText.trim()) return; 
 			 const userQueryForHistory = commandText; 
 			 aiInput.placeholder = "Thinking..."; aiInput.disabled = true; 
 			 aiInputContainer.classList.add('is-thinking'); 

 			 const systemPrompt = `You are an AI assistant for Iris Space. Your goal is to interpret user commands and respond in JSON format. Available intents: 'create_task', 'delete_task', 'set_reminder', 'create_note', 'general_query', 'set_countdown', 'export_data'. For 'delete_task', extract the text of the task to be removed. For 'set_reminder', extract the text and time in HH:MM format (e.g., '5pm' is '17:00'). For 'create_note' (diary entries) and 'general_query' (questions), your full_response is the main content. For 'export_data', details should include the format (e.g., 'pdf'). Respond ONLY with the JSON object. Do not add any text before or after the JSON object.`;
 
 			 let parts = [{ "text": commandText }];
             if (aiImageBase64 && aiImageMimeType) {
                 parts.push({ "inlineData": { "mimeType": aiImageMimeType, "data": aiImageBase64 } });
             }
 
 			 const payload = {
                  "contents": [{"parts": parts}],
                  "systemInstruction": { "parts": [{"text": systemPrompt }] }
              };
 
 			 try { 
 				 const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`, { 
                      method: 'POST', 
                      headers: { 'Content-Type': 'application/json' }, 
                      body: JSON.stringify(payload) 
                  }); 
 				 if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`); 
 				 const result = await response.json(); 
                  
                 if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                    throw new Error("Invalid response structure from API");
                 }
                 const rawText = result.candidates[0].content.parts[0].text;
                 let parsedResponse;
                 try {
                     const jsonString = rawText.replace(/```json|```/g, '').trim();
                     parsedResponse = JSON.parse(jsonString);
                 } catch (e) {
                     console.error("Failed to parse JSON from AI, treating as general query. Error:", e);
                     parsedResponse = { intent: 'general_query', details: { full_response: rawText, short_reply: 'Here is what I found:' } };
                 }
 				 handleAIResponse(parsedResponse, userQueryForHistory); 
 			 } catch (error) { 
 				 console.error("Error processing AI command:", error); 
 				 showAIReply("Sorry, I had trouble with that request."); 
 			 } finally { 
 				 aiInput.value = ''; aiInput.disabled = false; aiInput.placeholder = "Talk to Space..."; 
 				 aiInputContainer.classList.remove('is-thinking'); 
 				 document.getElementById('ai-image-preview-container').innerHTML = ''; 
 				 aiImageBase64 = null; aiImageMimeType = null; 
 			 } 
 		 } 
 		 function handleAIResponse(response, userQuery) { 
 			 if (!response || !response.intent) {
                showAIReply("Sorry, I couldn't understand the command.");
                return;
             }
             const { intent, details } = response;
 			 switch (intent) { 
 				 case 'create_task': 
                    if (details?.text) { createTask(details.text); } 
                    else { showAIReply("Sorry, I didn't get the task details."); }
                    break; 
 				 case 'delete_task': 
                    if (details?.text) { deleteTask(details.text); }
                    else { showAIReply("Sorry, I didn't get which task to delete."); }
                    break; 
 				 case 'set_reminder': 
                    if (details?.text && details?.time) { setReminder(details.text, details.time); }
                    else { showAIReply("Sorry, I missed the details for the reminder."); }
                    break; 
 				 case 'create_note': 
                    if (details?.full_response) { saveMoment(true, details.full_response); showAIReply("I've saved that as a moment."); }
                    else { showAIReply("Sorry, I didn't get the content for the note."); }
                    break; 
 				 case 'image_query': 
                 case 'summarize_day': 
                 case 'general_query': 
                    const aiResponseText = details?.full_response || response.full_response || "I'm not sure how to respond to that.";
                    saveToChatHistory(userQuery, aiResponseText); 
                    const shortReply = details?.short_reply || "I've added my response to our chat.";
                    showAIReply(shortReply, true);
                    break; 
 				 case 'set_countdown': 
                    if(details?.event && details?.date) { setCountdown(details.event, details.date); }
                    else { showAIReply("Sorry, I missed the details for the countdown."); }
                    break; 
                 case 'export_data': exportToPDF(); break;
 				 default: showAIReply("I didn't understand that command."); 
 			 } 
 		 } 
 		 async function setReminder(text, timeStr) { 
 			 if (Notification.permission !== 'granted') { showAIReply("Please enable notifications first."); return; } 
 			 if (!timeStr) { showAIReply("I need a specific time for the reminder."); return; } 
 			 const [hours, minutes] = timeStr.split(':').map(Number); 
 			 const now = new Date(); 
 			 const reminderTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0, 0); 
 			 if (reminderTime < now) reminderTime.setDate(reminderTime.getDate() + 1); 
 			 const delay = reminderTime.getTime() - now.getTime(); 
 			 setTimeout(() => { new Notification('Iris Space Reminder', { body: text, icon: 'https://placehold.co/192x192/0891b2/ffffff?text=IS' }); }, delay); 
            showAIReply(`Reminder set for ${timeStr}.`);
 		 } 
 		 async function createTask(text) { await dbAction(TASKS_STORE, 'readwrite', store => store.add({ text, completed: false, createdAt: Date.now() })); await renderWidgets(); showAIReply(`Task "${text}" created.`); } 
 		 async function deleteTask(text) { 
            if (!text) {
                showAIReply("Please tell me which task to remove.");
                return;
            }
            const tasks = await dbAction(TASKS_STORE, 'readonly', store => store.getAll());
            const taskToDelete = tasks.find(task => task.text.toLowerCase() === text.toLowerCase());

            if (taskToDelete) {
                await dbAction(TASKS_STORE, 'readwrite', store => store.delete(taskToDelete.id));
                await renderWidgets();
                showAIReply(`Task "${text}" has been removed.`);
            } else {
                showAIReply(`I couldn't find the task "${text}".`);
            }
        } 
 		 async function setCountdown(event, date) { await dbAction(SETTINGS_STORE, 'readwrite', store => store.put({ key: 'countdown', event, date })); await renderWidgets(); showAIReply(`Countdown set for ${event}.`); } 

 		 // --- NOTIFICATIONS ---
        async function checkNotifications() {
            if (!('Notification' in window) || Notification.permission !== 'granted') return;
            const tasks = await dbAction(TASKS_STORE, 'readonly', store => store.getAll());
            const now = Date.now();
            const twelveHours = 12 * 60 * 60 * 1000;
            tasks.forEach(async task => {
                if (!task.completed && !task.notificationSent && task.createdAt && (now - task.createdAt > twelveHours)) {
                    new Notification('Iris Space: Task Overdue', {
                        body: `Your task "${task.text}" is over 12 hours old.`,
                        icon: 'https://placehold.co/192x192/0891b2/ffffff?text=IS'
                    });
                    const updatedTask = { ...task, notificationSent: true };
                    await dbAction(TASKS_STORE, 'readwrite', store => store.put(updatedTask));
                }
            });

            const lastEventCheck = localStorage.getItem('lastEventCheck');
            const todayStr = new Date().toDateString();
            if (lastEventCheck !== todayStr) {
                const moments = await dbAction(MOMENTS_STORE, 'readonly', store => store.getAll());
                const todayMomentsCount = moments.filter(m => new Date(m.timestamp).toDateString() === todayStr).length;
                if (todayMomentsCount > 0) {
                     new Notification('Iris Space: Daily Brief', {
                        body: `You have ${todayMomentsCount} moment${todayMomentsCount > 1 ? 's' : ''} recorded for today.`,
                        icon: 'https://placehold.co/192x192/0891b2/ffffff?text=IS'
                    });
                }
                localStorage.setItem('lastEventCheck', todayStr);
            }
        }

        // --- EXPORT ---
        async function exportToPDF() {
            showAIReply("Generating your PDF...");
            const moments = await dbAction(MOMENTS_STORE, 'readonly', store => store.getAll());
            moments.sort((a,b) => a.timestamp - b.timestamp);

            const doc = new jsPDF();
            let yPos = 15;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 10;

            doc.setFont("helvetica", "bold");
            doc.setFontSize(20);
            doc.text("Iris Space - Moments Export", margin, yPos);
            yPos += 10;

            moments.forEach(m => {
                if (yPos > pageHeight - 30) {
                    doc.addPage();
                    yPos = margin;
                }

                doc.setFont("helvetica", "bold");
                doc.setFontSize(10);
                doc.text(new Date(m.timestamp).toLocaleString(), margin, yPos);
                yPos += 7;

                if (m.text) {
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(12);
                    const splitText = doc.splitTextToSize(m.text, doc.internal.pageSize.width - margin * 2);
                    doc.text(splitText, margin, yPos);
                    yPos += (splitText.length * 5) + 3;
                }
                
                if (m.tags && m.tags.length > 0) {
                    doc.setFont("helvetica", "italic");
                    doc.setFontSize(9);
                    doc.setTextColor(100);
                    doc.text(`Tags: ${m.tags.join(', ')}`, margin, yPos);
                    yPos += 8;
                    doc.setTextColor(0);
                }
                
                yPos += 5; 
                doc.setDrawColor(200);
                doc.line(margin, yPos, doc.internal.pageSize.width - margin, yPos);
                yPos += 7;
            });
            
            doc.save("iris-space-export.pdf");
            showAIReply("Your PDF has been downloaded.");
        }

 		 // --- OTHER PAGES --- 
 		 let graphAnimationId; 
 		 async function renderMindspaceGraph() { /* ... implementation ... */ } 
 		 async function renderCalendar(date) {
            const container = document.getElementById('calendar-container');
            container.innerHTML = '';
            currentCalendarDate = date; 
            const year = date.getFullYear();
            const month = date.getMonth();

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const header = document.createElement('div');
            header.className = 'flex justify-between items-center mb-4';
            header.innerHTML = `
                <button id="prev-month-btn" class="p-2 rounded-full hover:bg-white/10"><i data-lucide="chevron-left"></i></button>
                <h2 class="title-font text-2xl font-bold">${monthNames[month]} ${year}</h2>
                <button id="next-month-btn" class="p-2 rounded-full hover:bg-white/10"><i data-lucide="chevron-right"></i></button>
            `;
            container.appendChild(header);

            const grid = document.createElement('div');
            grid.id = 'calendar-grid';
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            daysOfWeek.forEach(day => {
                grid.innerHTML += `<div class="text-center font-semibold text-[var(--text-secondary)]">${day}</div>`;
            });

            const moments = await dbAction(MOMENTS_STORE, 'readonly', store => store.getAll());
            const momentsByDate = moments.reduce((acc, moment) => {
                const d = new Date(moment.timestamp).toDateString();
                if (!acc[d]) acc[d] = [];
                acc[d].push(moment);
                return acc;
            }, {});
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date().toDateString();

            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += '<div></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dateStr = currentDate.toDateString();
                const dayMoments = momentsByDate[dateStr] || [];
                
                let isTodayClass = dateStr === today ? 'is-today' : '';
                let dotsHTML = dayMoments.length > 0 ? `<div class="calendar-moment-dots">${dayMoments.slice(0, 3).map(() => '<div class="calendar-moment-dot"></div>').join('')}</div>` : '';
                
                grid.innerHTML += `
                    <div class="calendar-day ${isTodayClass}" data-date="${currentDate.toISOString()}">
                        <span class="calendar-day-number">${day}</span>
                        ${dotsHTML}
                    </div>
                `;
            }
            container.appendChild(grid);
            lucide.createIcons();
            
            document.getElementById('prev-month-btn').addEventListener('click', () => renderCalendar(new Date(year, month - 1, 1)));
            document.getElementById('next-month-btn').addEventListener('click', () => renderCalendar(new Date(year, month + 1, 1)));
            document.querySelectorAll('.calendar-day').forEach(day => {
                if(day.dataset.date) {
                    day.addEventListener('click', () => openDayModal(day.dataset.date));
                }
            });
         } 
 		 async function openDayModal(dateISO) {
            const date = new Date(dateISO);
            const dateStr = date.toDateString();
            document.getElementById('day-detail-title').textContent = date.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            const contentEl = document.getElementById('day-detail-content');
            contentEl.innerHTML = '<div class="text-center"><i data-lucide="loader-circle" class="w-8 h-8 animate-spin mx-auto"></i></div>';
            lucide.createIcons();
            showModal('day-detail-modal');

            const moments = await dbAction(MOMENTS_STORE, 'readonly', store => store.getAll());
            const dayMoments = moments.filter(m => new Date(m.timestamp).toDateString() === dateStr)
                                     .sort((a,b) => a.timestamp - b.timestamp);
            
            if (dayMoments.length === 0) {
                contentEl.innerHTML = `<div class="text-center mt-8 text-[var(--text-secondary)]"><i data-lucide="coffee" class="w-12 h-12 mx-auto"></i><p class="mt-4">Nothing recorded for this day.</p></div>`;
                lucide.createIcons();
                return;
            }

            contentEl.innerHTML = '';
            dayMoments.forEach(m => {
                 let mediaContent = '';
                 if (m.data) {
                     const mediaUrl = URL.createObjectURL(m.data);
                     if (m.type === 'image') mediaContent = `<img src="${mediaUrl}" class="mt-2 rounded-lg max-h-40 w-auto">`;
                     if (m.type === 'video') mediaContent = `<video controls src="${mediaUrl}" class="mt-2 rounded-lg w-full"></video>`;
                     if (m.type === 'audio') mediaContent = `<audio controls src="${mediaUrl}" class="w-full mt-2"></audio>`;
                 }
                 const tagsHTML = m.tags && m.tags.length ? `<div class="flex flex-wrap gap-2 mt-2">${m.tags.map(t => `<span class="timeline-tag">${t}</span>`).join('')}</div>` : '';
                
                contentEl.innerHTML += `
                    <div class="day-detail-entry p-3 rounded-lg">
                        <p class="text-xs text-[var(--text-secondary)] mb-1">${new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                        <p class="whitespace-pre-wrap">${m.text || ''}</p>
                        ${mediaContent}
                        ${tagsHTML}
                    </div>
                `;
            });
         } 
 	 </script> 
 </body> 
 </html>


